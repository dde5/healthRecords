<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JJ Breath Ultimate | Â∞àÊ•≠ÂëºÂê∏Ë®ìÁ∑¥</title>
    <style>
        :root {
            --primary-gold: #D4AF37;
            --gold-glow: #aa8a29;
            --bg-color: #000000;
            --panel-bg: #111111;
            --border-color: #333;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           Layout (RWD)
           ========================================= */
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .visual-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 90%);
        }

        .control-panel {
            flex-shrink: 0;
            width: 100%;
            height: 45%;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        @media (orientation: landscape) {
            .app-container { flex-direction: row; }
            .visual-area {
                flex: 6; 
                height: 100%;
                border-right: 1px solid var(--border-color);
            }
            .control-panel {
                flex: 4; 
                width: auto;
                height: 100%;
                border-top: none;
                border-left: 1px solid var(--border-color);
            }
        }

        /* =========================================
           UI Components
           ========================================= */
        h1 {
            color: var(--primary-gold);
            font-weight: 300;
            letter-spacing: 4px;
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            text-align: center;
        }

        select {
            width: 100%; padding: 12px; background: #222; border: 1px solid #444;
            color: var(--primary-gold); font-size: 1rem; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-bottom: 5px;
        }

        .duration-control { display: flex; gap: 5px; margin-bottom: 10px; }
        .time-btn {
            flex: 1; background: #222; border: 1px solid #444; color: #888;
            padding: 8px 0; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
            transition: all 0.2s;
        }
        .time-btn.active {
            background: var(--primary-gold); color: #000;
            border-color: var(--primary-gold); font-weight: bold;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .btn {
            flex: 1; padding: 15px; border: none; border-radius: 6px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .btn-start { background: linear-gradient(135deg, #D4AF37 0%, #997b28 100%); color: #000; }
        .btn-stop { background: #333; color: #888; border: 1px solid #555; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .options-bar {
            display: flex; justify-content: center; gap: 20px;
            color: #aaa; font-size: 0.9rem; margin-bottom: 5px;
        }
        .toggle-option { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .toggle-option input { accent-color: var(--primary-gold); width: 16px; height: 16px; }

        .info-card {
            background: #151515; border-left: 3px solid var(--primary-gold);
            padding: 15px; border-radius: 0 6px 6px 0; font-size: 0.95rem;
            line-height: 1.6; color: #ccc; white-space: pre-line;
        }
        .info-card h3 { 
            color: var(--primary-gold); margin: 0 0 10px 0; font-size: 1.1rem; 
            border-bottom: 1px solid #333; padding-bottom: 5px; 
        }

        .custom-inputs {
            display: none; grid-template-columns: repeat(4, 1fr); gap: 5px;
            background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .custom-inputs.show { display: grid; }
        .input-group label { font-size: 0.7rem; color: #aaa; display: block; text-align: center; }
        .input-group input { width: 100%; background: #000; border: 1px solid #555; color: var(--primary-gold); text-align: center; padding: 5px; }

        /* =========================================
           MASTER SVG & Lung Animation Styles
           ========================================= */
        
        .master-svg {
            width: 100%;
            height: 100%;
            max-width: 90vh;
            max-height: 90vh;
        }

        /* ËÉåÊôØËªåË∑°Á∑ö */
        .track-path {
            fill: none;
            stroke: #333;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.3s;
        }

        /* ÂëºÂê∏ÂÖâÈªû */
        .dot-circle {
            fill: #fff;
            stroke: var(--primary-gold);
            stroke-width: 2;
            filter: drop-shadow(0 0 8px var(--primary-gold));
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* ËÇ∫ÈÉ®ÂúñÂΩ¢Ê®£Âºè */
        .lung-base-fill {
            fill: #111; /* Á©∫ËÇ∫ÁöÑÈ°èËâ≤ */
            stroke: #333;
            stroke-width: 0.5;
        }

        .lung-liquid-fill {
            fill: url(#goldLinearGradient); /* ÈáëËâ≤Ê∂≤È´î */
            mask: url(#lungMask); /* ÈóúÈçµÔºöÂè™È°ØÁ§∫Âú®ËÇ∫ÁöÑÂΩ¢ÁãÄÂÖß */
        }
        
        .bronchi-lines {
            fill: none;
            stroke: #000;
            stroke-width: 0.5;
            opacity: 0.3; /* Ê∑°Ê∑°ÁöÑÊîØÊ∞£ÁÆ°Á¥ãÁêÜ */
        }

        .lung-outline {
            fill: none;
            stroke: var(--primary-gold);
            stroke-width: 1;
            opacity: 0.8;
            filter: drop-shadow(0 0 2px rgba(212,175,55,0.5));
        }

        /* SVG ÊñáÂ≠óÊ®£Âºè (ÊúÄÈ´òÂ±§Á¥ö) */
        .svg-text {
            font-family: "Helvetica Neue", Arial, sans-serif;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: #fff;
            pointer-events: none;
            paint-order: stroke;
            stroke: rgba(0,0,0,0.8); /* Ê∑±Ëâ≤ÊèèÈÇä */
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .text-timer { font-size: 28px; font-weight: 700; }
        .text-action { 
            font-size: 12px; font-weight: 900; letter-spacing: 3px; 
            fill: var(--primary-gold); text-transform: uppercase;
        }

        .total-timer {
            position: absolute; bottom: 10px; font-size: 1rem;
            color: #666; font-family: monospace;
        }
        .total-timer span { color: var(--primary-gold); }

        #wakeLockVideo { position: absolute; width: 1px; height: 1px; opacity: 0.001; pointer-events: none; }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Ë¶ñË¶∫ÂçÄ -->
        <div class="visual-area">
            <svg class="master-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <!-- ÈáëËâ≤ÂÖâÊæ§Êº∏Â±§ (Áî®ÊñºÊ∞£È´î) -->
                    <linearGradient id="goldLinearGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#fff4cc" /> <!-- È†ÇÈÉ®È´òÂÖâ -->
                        <stop offset="30%" stop-color="#D4AF37" />
                        <stop offset="100%" stop-color="#aa8a29" />
                    </linearGradient>

                    <!-- Ê∂≤‰ΩçÊéßÂà∂ Mask (Áî®Áü©ÂΩ¢‰æÜÈÅÆÁΩ©) -->
                    <!-- ÈªëËâ≤ÈÉ®ÂàÜÈö±ËóèÔºåÁôΩËâ≤ÈÉ®ÂàÜÈ°ØÁ§∫ -->
                    <mask id="liquidMask">
                        <!-- ÈªëËâ≤ËÉåÊôØ (ÂÖ®ÈÅÆ) -->
                        <rect x="0" y="0" width="100" height="100" fill="black" />
                        <!-- ÁôΩËâ≤Áü©ÂΩ¢ (È°ØÁ§∫ÂçÄÂüü) - YÂ∫ßÊ®ôÂãïÊÖãÊéßÂà∂Ê∞¥‰Ωç -->
                        <rect id="fillLevelRect" x="0" y="100" width="100" height="100" fill="white" />
                    </mask>

                    <!-- ËÇ∫ÈÉ®ÂΩ¢ÁãÄÂÆöÁæ© (ÈáçË§á‰ΩøÁî®) -->
                    <!-- Êõ¥Á≤æÁ∑ªÁöÑËÇ∫ÈÉ®Ë∑ØÂæë -->
                    <g id="complexLungShape">
                        <!-- Â∑¶ËÇ∫Ëëâ -->
                        <path d="M 46,30 
                                 C 44,28 40,28 38,32 
                                 C 30,45 25,60 25,75 
                                 C 25,85 35,90 42,88 
                                 C 46,87 46,75 46,75 
                                 Z" />
                        <!-- Âè≥ËÇ∫Ëëâ -->
                        <path d="M 54,30 
                                 C 56,28 60,28 62,32 
                                 C 70,45 75,60 75,75 
                                 C 75,85 65,90 58,88 
                                 C 54,87 54,75 54,75 
                                 Z" />
                        <!-- Ê∞£ÁÆ° -->
                        <path d="M 48,32 L 48,15 L 52,15 L 52,32" />
                    </g>
                    
                    <!-- ËÇ∫ÈÉ®ÈÅÆÁΩ© (Áî®‰æÜÈôêÂà∂Ê∂≤È´îÂè™Âú®ËÇ∫Ë£°Èù¢) -->
                    <mask id="lungMask">
                        <rect width="100" height="100" fill="black"/>
                        <use href="#complexLungShape" fill="white"/>
                    </mask>

                    <!-- ÊîØÊ∞£ÁÆ°Á¥ãÁêÜ (Ë£ùÈ£æÁî®) -->
                    <g id="bronchiTree">
                        <path d="M 50,32 Q 46,45 35,60 M 35,60 Q 30,70 28,75 M 35,60 Q 40,70 42,75" class="bronchi-lines"/>
                        <path d="M 50,32 Q 54,45 65,60 M 65,60 Q 70,70 72,75 M 65,60 Q 60,70 58,75" class="bronchi-lines"/>
                    </g>
                </defs>

                <!-- 1. ËÉåÊôØËªåË∑° -->
                <path id="trackPath" class="track-path" d="" />

                <!-- 2. ËÇ∫ÈÉ®ÂúñÂΩ¢ÁµÑ (Layering) -->
                <!-- Êï¥ÂÄãËÇ∫ÈÉ®ÁµÑÁ®çÂæÆÊîæÂ§ß(scale 1.35)‰∏¶ÁΩÆ‰∏≠ -->
                <!-- ÂéüÂßã path ‰∏≠ÂøÉÁ¥ÑÂú® (50, 50)ÔºåÊâÄ‰ª•ÂèØ‰ª•Áõ¥Êé• scale around center -->
                <!-- ÁÇ∫‰∫Ü‰øùÈö™ÔºåÊàëÂÄëÁî® transform origin center -->
                <g transform-origin="50 50" transform="scale(1.3)">
                    
                    <!-- Â∫ïÂ±§ÔºöÁ©∫ÁöÑËÇ∫ (Ê∑±Ëâ≤) -->
                    <use href="#complexLungShape" class="lung-base-fill" />
                    
                    <!-- Ê∂≤È´îÂ±§ÔºöÈáëËâ≤ÁöÑÊ∞£È´î -->
                    <!-- ÈÄôÂÄãÁü©ÂΩ¢Â°´ÊªøÈáëËâ≤ÔºåË¢´ "lungMask" (ËÇ∫ÂΩ¢ÁãÄ) Âíå "liquidMask" (Ê∞¥‰Ωç) ÂêåÊôÇÈÅÆÁΩ© -->
                    <!-- SVG Ê≤íÊúâÂ§öÈáç maskÔºåÊâÄ‰ª•ÊàëÂÄëÂµåÂ•ó -->
                    <g mask="url(#lungMask)">
                         <rect id="goldLiquid" x="0" y="0" width="100" height="100" fill="url(#goldLinearGradient)" mask="url(#liquidMask)" />
                    </g>

                    <!-- Á¥ãÁêÜÂ±§ÔºöÊîØÊ∞£ÁÆ° (ÁñäÂú®Ê∞£È´î‰∏ä) -->
                    <use href="#bronchiTree" />

                    <!-- È†ÇÂ±§ÔºöÈáëÂ±¨Â§ñÊ°Ü -->
                    <use href="#complexLungShape" class="lung-outline" />

                </g>

                <!-- 3. ÂëºÂê∏ÂÖâÈªû -->
                <circle id="dot" class="dot-circle" r="2.5" cx="0" cy="0" />

                <!-- 4. ÊñáÂ≠ó (ÊúÄ‰∏äÂ±§) -->
                <text id="timerText" class="svg-text text-timer" x="50" y="52"></text>
                <text id="actionText" class="svg-text text-action" x="50" y="65">READY</text>
            </svg>

            <div class="total-timer" id="totalTimerDisplay">
                Ââ©È§òÊôÇÈñì: <span>5:00</span>
            </div>
        </div>

        <!-- ÊéßÂà∂ÂçÄ -->
        <div class="control-panel">
            <h1>JJ BREATH</h1>

            <select id="breathSelector">
                <option value="box">ÊñπÂ°äÂëºÂê∏Ê≥ï (Box Breathing)</option>
                <option value="custom">‚öôÔ∏è Ëá™Ë®ÇÊ®°Âºè (Custom)</option>
                <option value="478">4-7-8 ÂëºÂê∏Ê≥ï (ÂÄí‰∏âËßí)</option>
                <option value="diaphragm">ËÖπÂºèÂëºÂê∏Ê≥ï (Ê≠£‰∏âËßí)</option>
                <option value="cyclic">Âæ™Áí∞Ê≠éÊÅØÂëºÂê∏ (ÂúìÂΩ¢)</option>
                <option value="humming">ËúÇÈ≥¥ÂëºÂê∏Ê≥ï (ÂúìÂΩ¢)</option>
            </select>

            <div class="duration-control">
                <button class="time-btn" data-min="1">1ÂàÜ</button>
                <button class="time-btn" data-min="3">3ÂàÜ</button>
                <button class="time-btn active" data-min="5">5ÂàÜ</button>
                <button class="time-btn" data-min="10">10ÂàÜ</button>
                <button class="time-btn" data-min="0">ÁÑ°Èôê</button>
            </div>

            <div class="custom-inputs" id="customPanel">
                <div class="input-group"><label>Âê∏Ê∞£</label><input type="number" id="cIn" value="4"></div>
                <div class="input-group"><label>ÈñâÊ∞£</label><input type="number" id="cH1" value="4"></div>
                <div class="input-group"><label>ÂêêÊ∞£</label><input type="number" id="cEx" value="4"></div>
                <div class="input-group"><label>ÈñâÊ∞£</label><input type="number" id="cH2" value="4"></div>
            </div>

            <div class="options-bar">
                <label class="toggle-option"><input type="checkbox" id="voiceToggle" checked> Ë™ûÈü≥</label>
                <label class="toggle-option"><input type="checkbox" id="soundToggle" checked> Èü≥Êïà</label>
            </div>

            <div class="btn-group">
                <button id="startBtn" class="btn btn-start">ÈñãÂßã START</button>
                <button id="stopBtn" class="btn btn-stop" disabled>ÂÅúÊ≠¢ STOP</button>
            </div>

            <div class="info-card">
                <h3 id="infoTitle">ÊñπÂ°äÂëºÂê∏Ê≥ï</h3>
                <div id="infoContent"></div>
            </div>
        </div>
    </div>

    <video id="wakeLockVideo" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNNEVAAAAAAAAAAAEAAACgYW1vbQAAAAAAAAAAAAAAAAAAAABtb292AAAAbG12aGQAAAAA6a2gAAAAAAHAAACaAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKgbWRhdAAAAAAAAAAAAAAA" type="video/mp4">
    </video>

    <script>
        // ============================================
        // ÂëºÂê∏Ê≥ïË®≠ÂÆöË≥áÊñôÂ∫´
        // ============================================
        const presets = {
            box: {
                title: "ÊñπÂ°äÂëºÂê∏Ê≥ï (Box Breathing)",
                shapePath: "M 10,90 L 10,10 L 90,10 L 90,90 L 10,90", 
                cycle: [4, 4, 4, 4],
                actions: ["Âê∏Ê∞£", "Êíê‰Ωè", "ÂêêÊ∞£", "Êíê‰Ωè"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `üí°Á∑äÂºµ„ÄÅÁÑ¶ÊÖÆ„ÄÅÂ£ìÂäõÂ§ßÊôÇÔºå‰Ω†ÊòØÂê¶ÊõæÊÑüÂà∞ÂøÉË∑≥Âä†ÈÄü„ÄÅËÖ¶Ë¢ãÁ©∫ÁôΩÔºüÂú®ÈÄôÊ®£ÁöÑÊôÇÂàªÔºåÊàëÂÄëÂÖ∂ÂØ¶ÂèØ‰ª•Èù†„ÄåÂëºÂê∏„ÄçÔºåÈáçÂïüÂÖßÂú®ÁöÑÁ©©ÂÆöÂäõ„ÄÇ

üí°ÁæéÂúãÊµ∑ËªçÈô∏Êà∞Èöä‰∏äÊà∞Â†¥ÂâçÔºåÈÉΩÊúÉÈÄ≤Ë°å‰∏ÄÈ†ÖÂëºÂê∏Ë®ìÁ∑¥‚Äî„ÄåÊñπÂ°äÂëºÂê∏Ê≥ï„ÄçÔºàBox BreathingÔºâ„ÄÇÈÄôÊòØ‰∏ÄÁ®ÆÁµêÂêàÂê∏Ê∞£„ÄÅÈñâÊ∞£„ÄÅÂêêÊ∞£ÁöÑÁ∞°ÂñÆÁ∑¥ÁøíÔºåÊØèÂÄãÈöéÊÆµÈÉΩÊòØ4ÁßíÔºåÂÉè‰∏ÄÂÄãÁ©©ÂÆöÁöÑÊ≠£ÊñπÂΩ¢ÁØÄÂ•èÔºåÂõ†Ê≠§Á®±‰Ωú„ÄåÊñπÂ°äÂëºÂê∏„Äç„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºàÊ≠£ÊñπÂΩ¢Âæ™Áí∞ÔºâÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 4 ÁßíÔºöÈªûÁî±‰∏ãÂæÄ‰∏äÔºåËÉΩÈáèÂÖÖÊªø„ÄÇ
2Ô∏è‚É£ Êíê‰Ωè 4 ÁßíÔºöÈªûÂêëÂè≥Ê©´ÁßªÔºåÊ∞£ÊÅØ‰øùÊåÅ„ÄÇ
3Ô∏è‚É£ ÂêêÊ∞£ 4 ÁßíÔºöÈªûÁî±‰∏äÂæÄ‰∏ãÔºåÂ£ìÂäõÈáãÊîæ„ÄÇ
4Ô∏è‚É£ Êíê‰Ωè 4 ÁßíÔºöÈªûÂêëÂ∑¶Ê©´ÁßªÔºåÊîæÁ©∫Ê≠∏Èõ∂„ÄÇ

ÂÜçÂæûÁ¨¨1Ê≠•ÈñãÂßãÂæ™Áí∞~ ÈÄôÊ®£ÁöÑÂëºÂê∏Ôºå‰∏çÂè™ÊòØÊîæÈ¨ÜÔºåÊõ¥ËÉΩÊ¥ªÂåñÂâØ‰∫§ÊÑüÁ•ûÁ∂ìÔºåÂπ´Âä©‰Ω†Âú®ÁÑ¶ÊÖÆ‰∏≠ÊâæÂõûÁ©©ÂÆö„ÄÇ`
            },
            custom: {
                title: "Ëá™Ë®ÇÊ®°Âºè (Custom Mode)",
                shapePath: "M 10,90 L 10,10 L 90,10 L 90,90 L 10,90",
                cycle: [4, 4, 4, 4],
                actions: ["Âê∏Ê∞£", "Êíê‰Ωè", "ÂêêÊ∞£", "Êíê‰Ωè"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `üí°ÈÄ≤Èöé‰ΩøÁî®ËÄÖÁöÑËá™Áî±Ë®≠ÂÆöÊ®°Âºè„ÄÇ

ÊÇ®ÂèØ‰ª•Ê†πÊìöËá™Â∑±ÁöÑËÇ∫Ê¥ªÈáèËàáË®ìÁ∑¥ÈúÄÊ±ÇÔºåÂú®‰∏äÊñπËº∏ÂÖ•Ê°ÜË™øÊï¥Ôºö
- Âê∏Ê∞£ÊôÇÈñì
- ÈñâÊ∞£ÔºàÂÖÖÁõàÔºâÊôÇÈñì
- ÂêêÊ∞£ÊôÇÈñì
- ÈñâÊ∞£ÔºàÊéíÁ©∫ÔºâÊôÇÈñì

ÈªûÊìä„ÄåÈñãÂßã„ÄçÂæåÂ∞á‰æùÁÖßÊÇ®ÁöÑË®≠ÂÆöÈÄ≤Ë°åÂæ™Áí∞„ÄÇ`
            },
            "478": {
                title: "4-7-8 ÂëºÂê∏Ê≥ï",
                shapePath: "M 50,90 L 10,10 L 90,10 L 50,90", 
                cycle: [4, 7, 8],
                actions: ["Âê∏Ê∞£", "ÈñâÊ∞£", "ÂêêÊ∞£"],
                effects: ["fill", "hold-full", "drain"],
                desc: `üí°Áï∂Â£ìÂäõ‰æÜË•≤ÊôÇÔºå‰Ω†ÊòØÂê¶ÊÉ≥Âø´ÈÄüÂπ≥Âæ©ÊÉÖÁ∑íÔºü4-7-8ÂëºÂê∏Ê≥ïÊòØÁî±Andrew WeilÂçöÂ£´ÈñãÁôºÁöÑÊäÄÂ∑ßÔºåÊ∫êËá™Áëú‰ºΩÊôÆÊãâÁ¥ç‰∫ûÁë™ÔºàpranayamaÔºâÔºåÁ†îÁ©∂È°ØÁ§∫ÂÆÉËÉΩÊúâÊïàÈôç‰ΩéÁÑ¶ÊÖÆÊ∞¥Âπ≥„ÄÅÊîπÂñÑÁù°Áú†Ôºå‰∏¶Ë™øÁØÄÁ•ûÁ∂ìÁ≥ªÁµ±„ÄÇ

üí°Ëá®Â∫äÁ†îÁ©∂ÁôºÁèæÔºåÈÄôÁ®ÆÂëºÂê∏Ê≥ïÂú®ÊâãË°ìÂæåÊÇ£ËÄÖ‰∏≠ËÉΩÈ°ØËëóÊ∏õÂ∞ëÁÑ¶ÊÖÆ„ÄÇÂæûÊ∞£ËÑàËßíÂ∫¶ÔºåÂÆÉÂº∑Ë™øÂª∂Èï∑ÂêêÊ∞£ÔºåÊúâÂä©ÊñºÈáãÊîæÁ©çÂ£ìÁöÑËÉΩÈáè„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºàÂÄí‰∏âËßíÂΩ¢ÔºâÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 4 ÁßíÔºöÈªûÂæûÂ∫ïÈÉ®ÂæÄ‰∏äÔºåÂê∏ÂÖ•ËÉΩÈáè„ÄÇ
2Ô∏è‚É£ ÈñâÊ∞£ 7 ÁßíÔºöÈªûÊ©´ÂêëÁßªÂãïÔºåÂÖÖÂàÜ‰∫§ÊèõÊ∞£È´î„ÄÇ
3Ô∏è‚É£ ÂêêÊ∞£ 8 ÁßíÔºöÈªûÂêë‰∏ãÂåØËÅöÔºåÂæπÂ∫ïÊîæÈ¨ÜÔºàÁôºÂá∫Âò∂ËÅ≤Ôºâ„ÄÇ

Âª∫Ë≠∞ÈÅ©ÂêàËÄÉË©¶ÂâçÊàñÁù°Ââç‰ΩøÁî®„ÄÇ`
            },
            diaphragm: {
                title: "ËÖπÂºèÂëºÂê∏Ê≥ï (Diaphragmatic)",
                shapePath: "M 10,90 L 50,10 L 90,90 L 10,90",
                cycle: [5, 5, 2],
                actions: ["Âê∏Ê∞£", "ÂêêÊ∞£", "ÊîæÈ¨Ü"],
                effects: ["fill", "drain", "hold-empty"],
                desc: `üí°ÊÑüË¶∫ÂëºÂê∏Ê∑∫Áü≠„ÄÅËÉ∏ÊÇ∂ÊôÇÔºåË©¶Ë©¶ËÖπÂºèÂëºÂê∏ÂêßÔºÅÈÄôÊòØÂü∫Á§éÁöÑÊ∑±ÂëºÂê∏ÊäÄÂ∑ßÔºåÂ∞àÊ≥®Êñº‰ΩøÁî®Ê©´ËÜàËÜúÔºåËÆìÂëºÂê∏Êõ¥Ê∑±Â±§ÔºåÁ†îÁ©∂Ë≠âÂØ¶ÂÆÉËÉΩÈôç‰ΩéÁîüÁêÜÂ£ìÂäõÊåáÊ®ôÔºåÂ¶ÇÁöÆË≥™ÈÜáÊ∞¥Âπ≥„ÄÇ

üí°Â§öÈ†ÖÁ†îÁ©∂È°ØÁ§∫ÔºåËÖπÂºèÂëºÂê∏ËÉΩÊúâÊïàÊ∏õËºïÁÑ¶ÊÖÆÂíåË≤†Èù¢ÊÉÖÁ∑í„ÄÇÂÆÉÊøÄÊ¥ªÂâØ‰∫§ÊÑüÁ•ûÁ∂ìÔºåÂπ´Âä©ÁñèÈÄöËÉ∏ËÖπËÉΩÈáèÔºå‰øÉÈÄ≤ÂÖßÂú®Á©©ÂÆö„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºàÊ≠£‰∏âËßíÂΩ¢ÔºâÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 5 ÁßíÔºöËÖπÈÉ®ÈºìËµ∑ÔºåÈªûÂæÄ‰∏äËµ∞„ÄÇ
2Ô∏è‚É£ ÂêêÊ∞£ 5 ÁßíÔºöËÖπÈÉ®Êî∂Á∏ÆÔºåÈªûÂæÄ‰∏ãËµ∞„ÄÇ
3Ô∏è‚É£ ÊîæÈ¨Ü 2 ÁßíÔºöÈªûÊ©´ÂêëÂõûÊ≠∏ÔºåÊ∫ñÂÇô‰∏ã‰∏ÄÊ¨°Âæ™Áí∞„ÄÇ

ÈÅ©ÂêàÂàùÂ≠∏ËÄÖÊàñÊó•Â∏∏Ê∏õÂ£ì„ÄÇ`
            },
            cyclic: {
                title: "Âæ™Áí∞Ê≠éÊÅØÂëºÂê∏ (Cyclic Sighing)",
                shapePath: "M 50,90 A 40,40 0 0 1 50,10 A 40,40 0 0 1 50,90", 
                cycle: [3, 1, 6],
                actions: ["Âê∏Ê∞£", "ÂÜçÂê∏", "Ê≠éÊ∞£"],
                effects: ["fill", "fill-max", "drain"],
                desc: `üí°ÊÉ≥Âú®Áü≠ÊôÇÈñìÂÖßÊîπÂñÑÂøÉÊÉÖÔºüÂæ™Áí∞Ê≠éÊÅØÂëºÂê∏ÊòØÁî±ÊñØÂù¶Á¶èÂ§ßÂ≠∏Á†îÁ©∂ÈñãÁôºÁöÑÊäÄÂ∑ßÔºåÂº∑Ë™øÂª∂Èï∑ÂêêÊ∞£ÔºåÁ†îÁ©∂È°ØÁ§∫ÂÆÉÊØîÂÖ∂‰ªñÂëºÂê∏Ê≥ïÊõ¥ÊúâÊïàÊèêÂçáÂøÉÊÉÖ‰∏¶Èôç‰ΩéÁîüÁêÜÂñöÈÜí„ÄÇ

üí°‰∏ÄÈ†ÖÊéßÂà∂Ë©¶È©óÁôºÁèæÔºåÊØèÂ§©5ÂàÜÈêòÁ∑¥ÁøíËÉΩÈ°ØËëóÊ∏õËºïÁÑ¶ÊÖÆ‰∏¶ÊîπÂñÑÊÉÖÁ∑íÔºåÁîöËá≥ÂÑ™ÊñºÊ≠£ÂøµÂÜ•ÊÉ≥„ÄÇÂÆÉÊ®°Êì¨Ëá™ÁÑ∂Ê≠éÊÅØÔºåÂπ´Âä©ÈáãÊîæÂ£ìÂäõËÉΩÈáè„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 3 ÁßíÔºöÈºªÂ≠êÊ∑±Âê∏Ê∞£ÔºåÊì¥ÂºµËÇ∫ÈÉ®„ÄÇ
2Ô∏è‚É£ ÂÜçÂê∏ 1 ÁßíÔºöÁü≠Âê∏‰∏ÄÂè£ÔºåË£úÊªøËÇ∫Ê¥ªÈáè„ÄÇ
3Ô∏è‚É£ Ê≠éÊ∞£ 6 ÁßíÔºöÂò¥Â∑¥Èï∑Èï∑ÂêêÊ∞£ÔºåÈáãÊîæÊâÄÊúâÂ£ìÂäõ„ÄÇ`
            },
            humming: {
                title: "ËúÇÈ≥¥ÂëºÂê∏Ê≥ï (Bhramari)",
                shapePath: "M 50,90 A 40,40 0 0 1 50,10 A 40,40 0 0 1 50,90",
                cycle: [4, 8],
                actions: ["Âê∏Ê∞£", "ËúÇÈ≥¥"],
                effects: ["fill", "drain"],
                desc: `üí°ËÖ¶‰∏≠Âó°Âó°‰∫ÇÊÉ≥ÊôÇÔºå‰æÜÈªûÊåØÂãïÁôÇÊ≥ïÔºÅËúÇÈ≥¥ÂëºÂê∏Ê≥ïÊ∫êËá™Áëú‰ºΩÔºåÈÄèÈÅéÂìºÈ≥¥ËÅ≤Áî¢ÁîüÊåØÂãïÔºåÁ†îÁ©∂È°ØÁ§∫ÂÆÉËÉΩÈôç‰ΩéÂøÉÁéá„ÄÅÊ∏õËºïÊå´ÊäòÊÑüÂíåÁÑ¶ÊÖÆ„ÄÇ

üí°Á≥ªÁµ±ÂõûÈ°ßÁôºÁèæÔºåÈÄôÁ®ÆÁ∑¥ÁøíËÉΩÊîπÂñÑÈ´òË°ÄÂ£ì„ÄÅÁÑ¶ÊÖÆÂíåÂ£ìÂäõÁõ∏ÈóúÁóáÁãÄ„ÄÇÊåØÂãïÊúâÂä©ÊñºÂà∫ÊøÄËÖ¶ÈÉ®ÔºåÁñèÈÄöËÉΩÈáèÂ†µÂ°ûÔºåÂ∏∂‰æÜÂØßÈùú„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 4 ÁßíÔºöÈªûÂæÄ‰∏äËµ∞„ÄÇ
2Ô∏è‚É£ ËúÇÈ≥¥ 8 ÁßíÔºöÈñâÂò¥ÁôºÂá∫„ÄåÂóØ‚Äî„ÄçËÅ≤ÂêêÊ∞£ÔºåÈªûÂæÄ‰∏ãËµ∞„ÄÇ

ÊØèÂ§©Êó©ÊôöÁ∑¥ÁøíÔºåÊïàÊûúÊõ¥‰Ω≥„ÄÇ`
            }
        };

        const ui = {
            select: document.getElementById('breathSelector'),
            customPanel: document.getElementById('customPanel'),
            cInputs: [document.getElementById('cIn'), document.getElementById('cH1'), document.getElementById('cEx'), document.getElementById('cH2')],
            title: document.getElementById('infoTitle'),
            content: document.getElementById('infoContent'),
            track: document.getElementById('trackPath'),
            dot: document.getElementById('dot'),
            timer: document.getElementById('timerText'),
            action: document.getElementById('actionText'),
            start: document.getElementById('startBtn'),
            stop: document.getElementById('stopBtn'),
            fillLevelRect: document.getElementById('fillLevelRect'),
            video: document.getElementById('wakeLockVideo'),
            voiceToggle: document.getElementById('voiceToggle'),
            soundToggle: document.getElementById('soundToggle'),
            totalTimer: document.getElementById('totalTimerDisplay'),
            timeBtns: document.querySelectorAll('.time-btn')
        };

        let isRunning = false;
        let animationFrame = null;
        let audioCtx = null;
        let currentKey = 'box';
        let wakeLock = null;
        let totalDurationMinutes = 5; 
        let sessionStartTime = 0;

        // ÂàùÂßãÂåñ
        loadPreset('box');
        updateTotalTimerDisplay(totalDurationMinutes * 60);

        ui.timeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(isRunning) return;
                ui.timeBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                totalDurationMinutes = parseInt(e.target.dataset.min);
                updateTotalTimerDisplay(totalDurationMinutes * 60);
            });
        });

        ui.select.addEventListener('change', (e) => {
            if(isRunning) stop();
            loadPreset(e.target.value);
        });

        ui.start.addEventListener('click', () => {
            ui.video.play().catch(()=>{});
            requestWakeLock();
            start();
        });

        ui.stop.addEventListener('click', () => stop(false));

        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible" && isRunning) {
                requestWakeLock();
                ui.video.play().catch(()=>{});
            }
        });

        function loadPreset(key) {
            currentKey = key;
            const data = presets[key];

            ui.customPanel.classList.toggle('show', key === 'custom');
            ui.title.innerText = data.title;
            ui.content.innerText = data.desc;
            
            ui.track.setAttribute('d', data.shapePath);
            const pt = ui.track.getPointAtLength(0);
            updateDot(pt);
            resetState();
        }

        function getCycle() {
            let data = JSON.parse(JSON.stringify(presets[currentKey]));
            if (currentKey === 'custom') {
                data.cycle = ui.cInputs.map(i => parseFloat(i.value) || 4);
            }
            return data;
        }

        async function start() {
            if(isRunning) return;
            isRunning = true;
            sessionStartTime = performance.now();

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();

            ui.start.disabled = true;
            ui.stop.disabled = false;
            ui.select.disabled = true;
            ui.customPanel.style.pointerEvents = 'none';
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'none');
            
            ui.dot.style.opacity = 1;

            runLoop();
        }

        function stop(finished = false) {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            window.speechSynthesis.cancel();
            
            ui.video.pause();
            if(wakeLock) wakeLock.release().then(()=> wakeLock=null);

            ui.start.disabled = false;
            ui.stop.disabled = true;
            ui.select.disabled = false;
            ui.customPanel.style.pointerEvents = 'auto';
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'auto');

            resetState();

            if (finished) {
                ui.action.textContent = "COMPLETE";
                ui.timer.textContent = "";
                playCompleteSound();
            }
        }

        function resetState() {
            ui.dot.style.opacity = 0;
            ui.timer.textContent = "";
            ui.action.textContent = "READY";
            setFluidLevel(100); 
            updateShapeColor('default');
            
            const pt = ui.track.getPointAtLength(0);
            updateDot(pt);
            
            if(totalDurationMinutes === 0) {
                 updateTotalTimerDisplay(0, true);
            } else {
                 updateTotalTimerDisplay(totalDurationMinutes * 60);
            }
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        async function runLoop() {
            const data = getCycle();
            let phaseIdx = 0;

            while(isRunning) {
                const duration = data.cycle[phaseIdx];
                const action = data.actions[phaseIdx];
                const effect = data.effects[phaseIdx];

                await runPhase(duration, action, effect, phaseIdx, data);
                
                if (checkTotalTimeUp()) {
                    stop(true);
                    break;
                }
                phaseIdx = (phaseIdx + 1) % data.cycle.length;
            }
        }

        function checkTotalTimeUp() {
            if (totalDurationMinutes === 0) return false;
            const elapsed = (performance.now() - sessionStartTime) / 1000;
            return elapsed >= (totalDurationMinutes * 60);
        }

        function runPhase(duration, action, effect, idx, data) {
            return new Promise(resolve => {
                const startTime = performance.now();
                const totalLen = ui.track.getTotalLength();
                const numSegments = data.cycle.length;
                let startRatio = idx / numSegments;
                let endRatio = (idx + 1) / numSegments;
                const segmentLen = (endRatio - startRatio) * totalLen;
                const baseDist = startRatio * totalLen;

                ui.action.textContent = action; 
                updateShapeColor(effect);

                let hasSpokenStart = false;
                let spokenCount = new Set();

                function frame(now) {
                    if(!isRunning) { resolve(); return; }

                    const sessionElapsed = (now - sessionStartTime) / 1000;
                    if (totalDurationMinutes > 0) {
                        const totalRemaining = (totalDurationMinutes * 60) - sessionElapsed;
                        updateTotalTimerDisplay(totalRemaining);
                        if (totalRemaining <= 0) { resolve(); return; }
                    } else {
                        updateTotalTimerDisplay(sessionElapsed, true);
                    }

                    const elapsed = (now - startTime) / 1000;
                    const progress = Math.min(elapsed / duration, 1);
                    const remaining = Math.ceil(duration - elapsed);

                    if(remaining >= 0) ui.timer.textContent = remaining;

                    if (!hasSpokenStart) {
                        hasSpokenStart = true;
                        speak(action);
                        playSound(effect);
                    }

                    if (remaining <= 3 && remaining >= 1 && !spokenCount.has(remaining)) {
                        spokenCount.add(remaining);
                        speak(remaining.toString());
                    }

                    const currentDist = baseDist + (segmentLen * progress);
                    const pt = ui.track.getPointAtLength(currentDist % totalLen);
                    updateDot(pt);
                    updateLung(effect, progress);

                    if(progress < 1) {
                        animationFrame = requestAnimationFrame(frame);
                    } else {
                        resolve();
                    }
                }
                animationFrame = requestAnimationFrame(frame);
            });
        }

        function updateTotalTimerDisplay(seconds, isElapsed = false) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const timeStr = `${m}:${s.toString().padStart(2, '0')}`;
            const label = isElapsed ? "Â∑≤Á∑¥Áøí: " : "Ââ©È§òÊôÇÈñì: ";
            ui.totalTimer.innerHTML = (totalDurationMinutes === 0 && !isElapsed) 
                ? "Ê®°Âºè: <span>ÁÑ°Èôê</span>" 
                : `${label}<span>${timeStr}</span>`;
        }

        function updateDot(pt) {
            ui.dot.setAttribute('cx', pt.x);
            ui.dot.setAttribute('cy', pt.y);
        }

        function updateLung(effect, progress) {
            let level = 100; // 100 = empty (Y=100)
            
            // Âê∏Ê∞£ÔºöÊ∞¥Áî±‰∏ãÂæÄ‰∏ä (Y: 100 -> 0)
            if(effect === 'fill') level = 100 - (progress * 100);
            // ÂêêÊ∞£ÔºöÊ∞¥Áî±‰∏äÂæÄ‰∏ã (Y: 0 -> 100)
            else if(effect === 'drain') level = progress * 100;
            // Êíê‰ΩèÊªø
            else if(effect === 'hold-full' || effect === 'fill-max') level = 0;
            // Êíê‰ΩèÁ©∫
            else if(effect === 'hold-empty') level = 100;
            
            setFluidLevel(level);
        }

        function setFluidLevel(yVal) {
            // ÊéßÂà∂ Mask Ë£°Èù¢ÁöÑ Rect Y Â∫ßÊ®ô
            // y=100 ÊôÇÂÆåÂÖ®ÈÅÆËîΩ(Èªë), y=0 ÊôÇÂÆåÂÖ®È°ØÁ§∫(ÁôΩ)
            ui.fillLevelRect.setAttribute('y', yVal);
        }

        function updateShapeColor(effect) {
            const path = ui.track;
            path.style.filter = "none";
            
            if (effect === 'fill' || effect === 'fill-max') {
                path.style.stroke = "#D4AF37";
                path.style.filter = "drop-shadow(0 0 5px #D4AF37)";
            } else if (effect === 'hold-full') {
                path.style.stroke = "#FFFFFF";
                path.style.filter = "drop-shadow(0 0 10px #FFFFFF)";
            } else if (effect === 'drain') {
                path.style.stroke = "#666";
            } else if (effect === 'hold-empty') {
                path.style.stroke = "#333";
            } else {
                path.style.stroke = "#333";
            }
        }

        function speak(text) {
            if(!ui.voiceToggle.checked) return;
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 1.3; 
            window.speechSynthesis.speak(u);
        }

        function playSound(effect) {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (effect === 'fill' || effect === 'fill-max') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(220, t);
                osc.frequency.linearRampToValueAtTime(440, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'drain') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, t);
                osc.frequency.linearRampToValueAtTime(220, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'hold-full') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(660, t);
                gain.gain.setValueAtTime(0.03, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.5);
            } else if (effect === 'hold-empty') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                osc.start(t);
                osc.stop(t + 0.4);
            }
        }

        function playCompleteSound() {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(330, t);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.0001, t + 3);
            osc.start(t);
            osc.stop(t + 3);
        }
    </script>
</body>
</html>
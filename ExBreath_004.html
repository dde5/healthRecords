<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHO Breath Ultimate | Â∞àÊ•≠ÂëºÂê∏Ë®ìÁ∑¥</title>
    <style>
        :root {
            --primary-gold: #D4AF37;
            --gold-dim: #8a7122;
            --white-glow: #ffffff;
            --bg-color: #000000;
            --card-bg: #111;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            overflow-y: auto; 
            overflow-x: hidden;
        }

        header {
            width: 100%;
            max-width: 400px;
            text-align: center;
            margin-bottom: 10px;
            z-index: 10;
        }

        h1 {
            color: var(--primary-gold);
            font-weight: 300;
            letter-spacing: 4px;
            margin: 0 0 10px 0;
            font-size: 1.4rem;
        }

        /* ÂëºÂê∏Ê≥ïÈÅ∏Êìá */
        .selector-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        select {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            color: var(--primary-gold);
            font-size: 1rem;
            border-radius: 6px;
            appearance: none;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }

        /* ÊôÇÈñìÈï∑Â∫¶Âø´ÈÅ∏ÂçÄ (Êñ∞ÂäüËÉΩ) */
        .duration-control {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .duration-label {
            font-size: 0.8rem;
            color: #888;
        }

        .duration-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .time-btn {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #888;
            padding: 8px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-btn.active {
            background: var(--primary-gold);
            color: #000;
            border-color: var(--primary-gold);
            font-weight: bold;
        }

        /* Ëá™Ë®ÇËº∏ÂÖ•ÂçÄ */
        .custom-inputs {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: #111;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed #444;
            margin-top: 5px;
        }
        .custom-inputs.show { display: grid; }
        .input-group label { font-size: 0.7rem; color: #888; display: block; text-align: center; }
        .input-group input { width: 100%; background: #000; border: 1px solid #555; color: var(--primary-gold); text-align: center; padding: 6px; border-radius: 4px; }

        /* Ë¶ñË¶∫ËàûÂè∞ */
        .visual-stage {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            flex-shrink: 0; 
        }

        .track-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 1;
        }

        .track-path {
            fill: none;
            stroke: #222;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke 0.3s, filter 0.3s;
        }

        .lung-wrapper {
            position: relative;
            width: 140px;
            height: 140px;
            z-index: 5;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .moving-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border: 2px solid var(--primary-gold);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary-gold);
            z-index: 20;
            opacity: 0;
            top: 0; left: 0;
            margin-top: -8px; margin-left: -8px;
            will-change: transform;
        }

        /* ‰∏≠Â§ÆË≥áË®ä */
        .center-info {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            pointer-events: none;
        }

        .timer-big {
            font-size: 3.5rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            line-height: 1;
            text-shadow: 0 0 10px rgba(0,0,0,0.9), 0 0 20px rgba(0,0,0,0.7);
        }

        .action-text {
            font-size: 1.5rem;
            color: var(--primary-gold);
            letter-spacing: 2px;
            margin-top: 10px;
            font-weight: 900;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,1), 0 0 10px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.4);
            padding: 2px 10px;
            border-radius: 4px;
        }

        /* Á∏ΩÊôÇÈñìÈ°ØÁ§∫ */
        .total-timer-display {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
            font-family: monospace;
            letter-spacing: 1px;
        }
        .total-timer-display span {
            color: var(--primary-gold);
            font-weight: bold;
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .controls {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 50;
        }

        .options-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .toggle-option { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .toggle-option input { accent-color: var(--primary-gold); width: 16px; height: 16px; }

        .btn-group { display: flex; gap: 10px; }
        .btn {
            flex: 1; padding: 14px; border: none; border-radius: 6px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .btn-start { background: linear-gradient(135deg, #D4AF37 0%, #997b28 100%); color: #000; }
        .btn-stop { background: #222; color: #666; border: 1px solid #444; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Ë™™ÊòéÂç°Áâá */
        .info-card {
            width: 100%; 
            max-width: 400px;
            background: var(--card-bg); 
            border-left: 3px solid var(--primary-gold);
            padding: 20px; 
            border-radius: 0 8px 8px 0; 
            margin-top: 30px;
            margin-bottom: 50px;
        }
        .info-card h3 { 
            color: var(--primary-gold); 
            margin: 0 0 15px 0; 
            font-size: 1.2rem; 
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .info-card .content {
            font-size: 0.95rem; 
            color: #ddd; 
            line-height: 1.6;
            white-space: pre-line;
        }

        #wakeLockVideo {
            position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; top: 0; left: 0;
        }
    </style>
</head>
<body>

    <header>
        <h1>AHO BREATH</h1>
        
        <div class="selector-wrapper">
            <select id="breathSelector">
                <option value="box">ÊñπÂ°äÂëºÂê∏Ê≥ï (Box Breathing)</option>
                <option value="custom">‚öôÔ∏è Ëá™Ë®ÇÊ®°Âºè (Custom)</option>
                <option value="478">4-7-8 ÂëºÂê∏Ê≥ï (Relax)</option>
                <option value="diaphragm">ËÖπÂºèÂëºÂê∏Ê≥ï (Basic)</option>
                <option value="cyclic">Âæ™Áí∞Ê≠éÊÅØÂëºÂê∏ (Cyclic)</option>
                <option value="humming">ËúÇÈ≥¥ÂëºÂê∏Ê≥ï (Humming)</option>
            </select>
        </div>

        <!-- Ë®ìÁ∑¥ÊôÇÈï∑Âø´ÈÅ∏ -->
        <div class="duration-control">
            <div class="duration-label">Á∑¥ÁøíÈï∑Â∫¶</div>
            <div class="duration-buttons" id="durationBtns">
                <button class="time-btn" data-min="1">1ÂàÜ</button>
                <button class="time-btn" data-min="3">3ÂàÜ</button>
                <button class="time-btn active" data-min="5">5ÂàÜ</button>
                <button class="time-btn" data-min="10">10ÂàÜ</button>
                <button class="time-btn" data-min="0">ÁÑ°Èôê</button>
            </div>
        </div>

        <div class="custom-inputs" id="customPanel">
            <div class="input-group"><label>Âê∏Ê∞£</label><input type="number" id="cIn" value="4"></div>
            <div class="input-group"><label>ÈñâÊ∞£</label><input type="number" id="cH1" value="4"></div>
            <div class="input-group"><label>ÂêêÊ∞£</label><input type="number" id="cEx" value="4"></div>
            <div class="input-group"><label>ÈñâÊ∞£</label><input type="number" id="cH2" value="4"></div>
        </div>
    </header>

    <div class="visual-stage">
        <svg class="track-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
            <path id="trackPath" class="track-path" d="" />
        </svg>

        <div id="dot" class="moving-dot"></div>

        <div class="lung-wrapper" id="lungWrapper">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="fluidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop id="stopTop" offset="100%" stop-color="transparent" />
                        <stop id="stopBottom" offset="100%" stop-color="#D4AF37" />
                    </linearGradient>
                    <g id="lungShape">
                        <path d="M 95,40 C 60,40 35,70 35,110 C 35,150 65,170 90,165 C 95,164 95,140 95,140 Z" />
                        <path d="M 105,40 C 140,40 165,70 165,110 C 165,150 135,170 110,165 C 105,164 105,140 105,140 Z" />
                    </g>
                </defs>
                <use href="#lungShape" fill="#111" stroke="#333" stroke-width="2" />
                <use href="#lungShape" fill="url(#fluidGradient)" />
                <use href="#lungShape" fill="none" stroke="#D4AF37" stroke-width="2" />
                <path d="M 95,40 L 95,10 L 105,10 L 105,40" stroke="#D4AF37" stroke-width="2" fill="none"/>
            </svg>
        </div>

        <div class="center-info">
            <div id="timerDisplay" class="timer-big"></div>
            <div id="actionDisplay" class="action-text">READY</div>
        </div>
    </div>

    <div class="total-timer-display" id="totalTimerDisplay">
        Ââ©È§òÊôÇÈñì: <span>5:00</span>
    </div>

    <div class="controls">
        <div class="options-bar">
            <label class="toggle-option"><input type="checkbox" id="voiceToggle" checked> Ë™ûÈü≥</label>
            <label class="toggle-option"><input type="checkbox" id="soundToggle" checked> Èü≥Êïà</label>
        </div>
        <div class="btn-group">
            <button id="startBtn" class="btn btn-start">ÈñãÂßã START</button>
            <button id="stopBtn" class="btn btn-stop" disabled>ÂÅúÊ≠¢ STOP</button>
        </div>
    </div>

    <div class="info-card">
        <h3 id="infoTitle">ÊñπÂ°äÂëºÂê∏Ê≥ï</h3>
        <div id="infoContent" class="content"></div>
    </div>

    <video id="wakeLockVideo" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNNEVAAAAAAAAAAAEAAACgYW1vbQAAAAAAAAAAAAAAAAAAAABtb292AAAAbG12aGQAAAAA6a2gAAAAAAHAAACaAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKgbWRhdAAAAAAAAAAAAAAA" type="video/mp4">
    </video>

    <script>
        const presets = {
            box: {
                title: "ÊñπÂ°äÂëºÂê∏Ê≥ï (Box Breathing)",
                shape: "square",
                cycle: [4, 4, 4, 4],
                actions: ["Âê∏Ê∞£", "Êíê‰Ωè", "ÂêêÊ∞£", "Êíê‰Ωè"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `üí°Á∑äÂºµ„ÄÅÁÑ¶ÊÖÆ„ÄÅÂ£ìÂäõÂ§ßÊôÇÔºå‰Ω†ÊòØÂê¶ÊõæÊÑüÂà∞ÂøÉË∑≥Âä†ÈÄü„ÄÅËÖ¶Ë¢ãÁ©∫ÁôΩÔºüÂú®ÈÄôÊ®£ÁöÑÊôÇÂàªÔºåÊàëÂÄëÂÖ∂ÂØ¶ÂèØ‰ª•Èù†„ÄåÂëºÂê∏„ÄçÔºåÈáçÂïüÂÖßÂú®ÁöÑÁ©©ÂÆöÂäõ„ÄÇ

üí°ÁæéÂúãÊµ∑ËªçÈô∏Êà∞Èöä‰∏äÊà∞Â†¥ÂâçÔºåÈÉΩÊúÉÈÄ≤Ë°å‰∏ÄÈ†ÖÂëºÂê∏Ë®ìÁ∑¥‚Äî„ÄåÊñπÂ°äÂëºÂê∏Ê≥ï„ÄçÔºàBox BreathingÔºâ„ÄÇÈÄôÊòØ‰∏ÄÁ®ÆÁµêÂêàÂê∏Ê∞£„ÄÅÈñâÊ∞£„ÄÅÂêêÊ∞£ÁöÑÁ∞°ÂñÆÁ∑¥ÁøíÔºåÊØèÂÄãÈöéÊÆµÈÉΩÊòØ4ÁßíÔºåÂÉè‰∏ÄÂÄãÁ©©ÂÆöÁöÑÊ≠£ÊñπÂΩ¢ÁØÄÂ•è„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ Âê∏Ê∞£ 4 Áßí
2Ô∏è‚É£ ÈñâÊ∞£ÔºàÊíê‰ΩèÔºâ4 Áßí
3Ô∏è‚É£ ÂêêÊ∞£ 4 Áßí
4Ô∏è‚É£ ÈñâÊ∞£ÔºàÊíê‰ΩèÔºâ4 Áßí
ÁÑ∂ÂæåÔºåÂÜçÂæûÁ¨¨1Ê≠•ÈñãÂßãÂæ™Áí∞~`
            },
            custom: {
                title: "Ëá™Ë®ÇÊ®°Âºè (Custom Mode)",
                shape: "square",
                cycle: [4, 4, 4, 4],
                actions: ["Âê∏Ê∞£", "Êíê‰Ωè", "ÂêêÊ∞£", "Êíê‰Ωè"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `üí°ÈÄ≤Èöé‰ΩøÁî®ËÄÖÁöÑËá™Áî±Ë®≠ÂÆöÊ®°Âºè„ÄÇ

ÊÇ®ÂèØ‰ª•Ê†πÊìöËá™Â∑±ÁöÑËÇ∫Ê¥ªÈáèËàáË®ìÁ∑¥ÈúÄÊ±ÇÔºåÂú®‰∏äÊñπËº∏ÂÖ•Ê°ÜË™øÊï¥ÁßíÊï∏„ÄÇ
ÈªûÊìä„ÄåÈñãÂßã„ÄçÂæåÂ∞á‰æùÁÖßÊÇ®ÁöÑË®≠ÂÆöÈÄ≤Ë°åÂæ™Áí∞„ÄÇ`
            },
            "478": {
                title: "4-7-8 ÂëºÂê∏Ê≥ï",
                shape: "triangle",
                cycle: [4, 7, 8],
                actions: ["Âê∏Ê∞£", "ÈñâÊ∞£", "ÂêêÊ∞£"],
                effects: ["fill", "hold-full", "drain"],
                desc: `üí°Áï∂Â£ìÂäõ‰æÜË•≤ÊôÇÔºå‰Ω†ÊòØÂê¶ÊÉ≥Âø´ÈÄüÂπ≥Âæ©ÊÉÖÁ∑íÔºü4-7-8ÂëºÂê∏Ê≥ïÊ∫êËá™Áëú‰ºΩÊôÆÊãâÁ¥ç‰∫ûÁë™ÔºåÁ†îÁ©∂È°ØÁ§∫ÂÆÉËÉΩÊúâÊïàÈôç‰ΩéÁÑ¶ÊÖÆÊ∞¥Âπ≥„ÄÅÊîπÂñÑÁù°Áú†„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ ÂùêÊàñË∫∫‰∏ãÔºåËàåÂ∞ñÈ†Ç‰Ωè‰∏äÈ°é„ÄÇ
2Ô∏è‚É£ ÈºªÂ≠êÂê∏Ê∞£ 4 Áßí„ÄÇ
3Ô∏è‚É£ ÈñâÊ∞£ 7 Áßí„ÄÇ
4Ô∏è‚É£ Âò¥Â∑¥ÂêêÊ∞£ 8 ÁßíÔºàÁôºÂá∫„ÄåÂò∂„ÄçËÅ≤Ôºâ„ÄÇ`
            },
            diaphragm: {
                title: "ËÖπÂºèÂëºÂê∏Ê≥ï (Diaphragmatic)",
                shape: "circle",
                cycle: [5, 5, 2],
                actions: ["Âê∏Ê∞£", "ÂêêÊ∞£", "ÊîæÈ¨Ü"],
                effects: ["fill", "drain", "hold-empty"],
                desc: `üí°ÊÑüË¶∫ÂëºÂê∏Ê∑∫Áü≠„ÄÅËÉ∏ÊÇ∂ÊôÇÔºåË©¶Ë©¶ËÖπÂºèÂëºÂê∏ÂêßÔºÅÈÄôÊòØÂü∫Á§éÁöÑÊ∑±ÂëºÂê∏ÊäÄÂ∑ßÔºåÂ∞àÊ≥®Êñº‰ΩøÁî®Ê©´ËÜàËÜú„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ ‰∏ÄÊâãÊîæÂú®ËÉ∏ÈÉ®Ôºå‰∏ÄÊâãÊîæÂú®ËÖπÈÉ®„ÄÇ
2Ô∏è‚É£ ÈºªÂ≠êÂê∏Ê∞£ÔºåËÆìËÖπÈÉ®ÈºìËµ∑ÔºàËÉ∏ÈÉ®‰∏çÂãïÔºâÔºåÊåÅÁ∫å 5 Áßí„ÄÇ
3Ô∏è‚É£ Âò¥Â∑¥Á∑©ÊÖ¢ÂêêÊ∞£ÔºåËÆìËÖπÈÉ®Êî∂Á∏ÆÔºåÊåÅÁ∫å 5 Áßí„ÄÇ
4Ô∏è‚É£ ‰ºëÊÅØ 2 ÁßíÔºåÈáçË§áÂæ™Áí∞„ÄÇ`
            },
            cyclic: {
                title: "Âæ™Áí∞Ê≠éÊÅØÂëºÂê∏ (Cyclic Sighing)",
                shape: "circle",
                cycle: [3, 1, 6],
                actions: ["Âê∏Ê∞£", "ÂÜçÂê∏", "Ê≠éÊ∞£"],
                effects: ["fill", "fill-max", "drain"],
                desc: `üí°ÊÉ≥Âú®Áü≠ÊôÇÈñìÂÖßÊîπÂñÑÂøÉÊÉÖÔºüÂæ™Áí∞Ê≠éÊÅØÂëºÂê∏ÊòØÁî±ÊñØÂù¶Á¶èÂ§ßÂ≠∏Á†îÁ©∂ÈñãÁôºÁöÑÊäÄÂ∑ß„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ ÈºªÂ≠êÊ∑±Âê∏Ê∞£ÔºåÊì¥ÂºµËÇ∫ÈÉ®„ÄÇ
2Ô∏è‚É£ Áü≠Êö´ÂÅúÈ†ìÂæåÔºåÂÜçÂê∏ÂÖ•‰∏ÄÂ∞èÂè£Á©∫Ê∞£ÔºàËÆìËÇ∫ÈÉ®ÂÖ®ÊªøÔºâ„ÄÇ
3Ô∏è‚É£ Âò¥Â∑¥Èï∑Èï∑ÂêêÊ∞£ÔºàÊ≠éÊÅØËà¨ÔºâÔºåÊåÅÁ∫åÊôÇÈñìÊØîÂê∏Ê∞£Èï∑„ÄÇ`
            },
            humming: {
                title: "ËúÇÈ≥¥ÂëºÂê∏Ê≥ï (Bhramari)",
                shape: "circle",
                cycle: [4, 8],
                actions: ["Âê∏Ê∞£", "ËúÇÈ≥¥"],
                effects: ["fill", "drain"],
                desc: `üí°ËÖ¶‰∏≠Âó°Âó°‰∫ÇÊÉ≥ÊôÇÔºå‰æÜÈªûÊåØÂãïÁôÇÊ≥ïÔºÅËúÇÈ≥¥ÂëºÂê∏Ê≥ïÊ∫êËá™Áëú‰ºΩÔºåÈÄèÈÅéÂìºÈ≥¥ËÅ≤Áî¢ÁîüÊåØÂãï„ÄÇ

Á∑¥ÁøíÊñπÂºèÂ¶Ç‰∏ãÔºö
1Ô∏è‚É£ ÂùêÁõ¥ÔºåÈñâÁúº„ÄÇ
2Ô∏è‚É£ ÈºªÂ≠êÊ∑±Âê∏Ê∞£ 4 Áßí„ÄÇ
3Ô∏è‚É£ ÈñâÂò¥ÔºåÂìºÈ≥¥ÂêêÊ∞£ÔºàÂÉèËúúËúÇÂó°Âó°ËÅ≤ÔºâÔºåÊåÅÁ∫å 8 Áßí„ÄÇ`
            }
        };

        const ui = {
            select: document.getElementById('breathSelector'),
            customPanel: document.getElementById('customPanel'),
            cInputs: [document.getElementById('cIn'), document.getElementById('cH1'), document.getElementById('cEx'), document.getElementById('cH2')],
            title: document.getElementById('infoTitle'),
            content: document.getElementById('infoContent'),
            track: document.getElementById('trackPath'),
            dot: document.getElementById('dot'),
            timer: document.getElementById('timerDisplay'),
            action: document.getElementById('actionDisplay'),
            start: document.getElementById('startBtn'),
            stop: document.getElementById('stopBtn'),
            lung: document.getElementById('lungWrapper'),
            stopTop: document.getElementById('stopTop'),
            stopBottom: document.getElementById('stopBottom'),
            video: document.getElementById('wakeLockVideo'),
            voiceToggle: document.getElementById('voiceToggle'),
            soundToggle: document.getElementById('soundToggle'),
            totalTimer: document.getElementById('totalTimerDisplay'),
            timeBtns: document.querySelectorAll('.time-btn')
        };

        let isRunning = false;
        let animationFrame = null;
        let audioCtx = null;
        let currentKey = 'box';
        let wakeLock = null;
        
        // Á∏ΩÊôÇÈñìË®≠ÂÆö (È†êË®≠5ÂàÜÈêò)
        let totalDurationMinutes = 5; 
        let sessionStartTime = 0;

        loadPreset('box');
        updateTotalTimerDisplay(totalDurationMinutes * 60);

        // ‰∫ã‰ª∂ÔºöÊôÇÈñìÈÅ∏Êìá
        ui.timeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(isRunning) return; // Âü∑Ë°å‰∏≠‰∏çËÉΩÊèõÊôÇÈñì
                // UI ÂàáÊèõ
                ui.timeBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Ë®≠ÂÆöÊï∏ÂÄº
                totalDurationMinutes = parseInt(e.target.dataset.min);
                
                // Êõ¥Êñ∞È°ØÁ§∫
                const totalSecs = totalDurationMinutes * 60;
                updateTotalTimerDisplay(totalSecs);
            });
        });

        ui.select.addEventListener('change', (e) => {
            if(isRunning) stop();
            loadPreset(e.target.value);
        });

        ui.start.addEventListener('click', () => {
            ui.video.play().catch(()=>{});
            requestWakeLock();
            start();
        });

        ui.stop.addEventListener('click', () => stop(false));

        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible" && isRunning) {
                requestWakeLock();
                ui.video.play().catch(()=>{});
            }
        });

        function loadPreset(key) {
            currentKey = key;
            const data = presets[key];

            ui.customPanel.classList.toggle('show', key === 'custom');
            ui.title.innerText = data.title;
            ui.content.innerText = data.desc;
            
            drawShape(data.shape);
            resetState();
        }

        function getCycle() {
            let data = JSON.parse(JSON.stringify(presets[currentKey]));
            if (currentKey === 'custom') {
                data.cycle = ui.cInputs.map(i => parseFloat(i.value) || 4);
            }
            return data;
        }

        async function start() {
            if(isRunning) return;
            isRunning = true;
            sessionStartTime = performance.now();

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();

            ui.start.disabled = true;
            ui.stop.disabled = false;
            ui.select.disabled = true;
            ui.customPanel.style.pointerEvents = 'none';
            // ÈéñÂÆöÊôÇÈñìÊåâÈàï
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'none');
            
            ui.dot.style.opacity = 1;
            ui.lung.style.opacity = 1;

            runLoop();
        }

        function stop(finished = false) {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            window.speechSynthesis.cancel();
            
            ui.video.pause();
            if(wakeLock) wakeLock.release().then(()=> wakeLock=null);

            ui.start.disabled = false;
            ui.stop.disabled = true;
            ui.select.disabled = false;
            ui.customPanel.style.pointerEvents = 'auto';
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'auto');

            resetState();

            if (finished) {
                ui.action.innerText = "COMPLETE";
                ui.timer.innerText = "";
                playCompleteSound();
            }
        }

        function resetState() {
            ui.dot.style.opacity = 0;
            ui.lung.style.opacity = 0.3;
            ui.timer.innerText = "";
            ui.action.innerText = "READY";
            setFluidLevel(100);
            updateShapeColor('default');
            
            const pt = ui.track.getPointAtLength(0);
            updateDot(pt);
            
            // ÈáçÁΩÆÁ∏ΩÊôÇÈñìÈ°ØÁ§∫
            if(totalDurationMinutes === 0) {
                 updateTotalTimerDisplay(0, true);
            } else {
                 updateTotalTimerDisplay(totalDurationMinutes * 60);
            }
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        async function runLoop() {
            const data = getCycle();
            let phaseIdx = 0;

            while(isRunning) {
                const duration = data.cycle[phaseIdx];
                const action = data.actions[phaseIdx];
                const effect = data.effects[phaseIdx];

                await runPhase(duration, action, effect, phaseIdx, data);
                
                // Ê™¢Êü•ÊòØÂê¶ÊôÇÈñìÂà∞
                if (checkTotalTimeUp()) {
                    stop(true);
                    break;
                }
                
                phaseIdx = (phaseIdx + 1) % data.cycle.length;
            }
        }

        function checkTotalTimeUp() {
            if (totalDurationMinutes === 0) return false; // ÁÑ°ÈôêÊ®°Âºè
            const elapsed = (performance.now() - sessionStartTime) / 1000;
            return elapsed >= (totalDurationMinutes * 60);
        }

        function runPhase(duration, action, effect, idx, data) {
            return new Promise(resolve => {
                const startTime = performance.now();
                const totalLen = ui.track.getTotalLength();
                const segmentLen = totalLen / data.cycle.length;
                const startDist = idx * segmentLen;

                ui.action.innerText = action; 
                updateShapeColor(effect);

                let hasSpokenStart = false;
                let spokenCount = new Set();

                function frame(now) {
                    if(!isRunning) { resolve(); return; }

                    // 1. Ë®àÁÆóÁ∏ΩÊôÇÈñì
                    const sessionElapsed = (now - sessionStartTime) / 1000;
                    if (totalDurationMinutes > 0) {
                        const totalRemaining = (totalDurationMinutes * 60) - sessionElapsed;
                        updateTotalTimerDisplay(totalRemaining);
                        if (totalRemaining <= 0) {
                            resolve(); // ÁµêÊùüÊ≠§ÈöéÊÆµÔºåËÆì runLoop ÊäìÂà∞ÊôÇÈñìÂà∞
                            return;
                        }
                    } else {
                        // ÁÑ°ÈôêÊ®°ÂºèÈ°ØÁ§∫Â∑≤ÈÅéÊôÇÈñì
                        updateTotalTimerDisplay(sessionElapsed, true);
                    }

                    // 2. Ë®àÁÆóÈöéÊÆµÊôÇÈñì
                    const elapsed = (now - startTime) / 1000;
                    const progress = Math.min(elapsed / duration, 1);
                    const remaining = Math.ceil(duration - elapsed);

                    if(remaining >= 0) ui.timer.innerText = remaining;

                    if (!hasSpokenStart) {
                        hasSpokenStart = true;
                        speak(action);
                        playSound(effect);
                    }

                    if (remaining <= 3 && remaining >= 1 && !spokenCount.has(remaining)) {
                        spokenCount.add(remaining);
                        speak(remaining.toString());
                    }

                    const currentDist = startDist + (segmentLen * progress);
                    const pt = ui.track.getPointAtLength(currentDist % totalLen);
                    updateDot(pt);
                    updateLung(effect, progress);

                    if(progress < 1) {
                        animationFrame = requestAnimationFrame(frame);
                    } else {
                        resolve();
                    }
                }
                animationFrame = requestAnimationFrame(frame);
            });
        }

        function updateTotalTimerDisplay(seconds, isElapsed = false) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const timeStr = `${m}:${s.toString().padStart(2, '0')}`;
            
            const label = isElapsed ? "Â∑≤Á∑¥Áøí: " : "Ââ©È§òÊôÇÈñì: ";
            if (totalDurationMinutes === 0 && !isElapsed) {
                 ui.totalTimer.innerHTML = "Ê®°Âºè: <span>ÁÑ°Èôê</span>";
            } else {
                 ui.totalTimer.innerHTML = `${label}<span>${timeStr}</span>`;
            }
        }

        function drawShape(type) {
            let d = "";
            if(type === 'square') d = "M 10,10 L 90,10 L 90,90 L 10,90 Z"; 
            else if(type === 'triangle') d = "M 50,10 L 90,85 L 10,85 Z";
            else d = "M 50,10 A 40,40 0 1,1 49.9,10 Z";
            ui.track.setAttribute('d', d);
            updateDot(ui.track.getPointAtLength(0));
        }

        function updateDot(pt) {
            const scale = 300 / 100;
            ui.dot.style.transform = `translate(${pt.x * scale}px, ${pt.y * scale}px)`;
        }

        function updateLung(effect, progress) {
            let level = 100;
            if(effect === 'fill') level = 100 - (progress * 100);
            else if(effect === 'drain') level = progress * 100;
            else if(effect === 'hold-full' || effect === 'fill-max') level = 0;
            else if(effect === 'hold-empty') level = 100;
            setFluidLevel(level);
        }

        function setFluidLevel(pct) {
            ui.stopTop.setAttribute('offset', pct + '%');
            ui.stopBottom.setAttribute('offset', pct + '%');
        }

        function updateShapeColor(effect) {
            const path = ui.track;
            path.style.filter = "none";
            path.style.strokeWidth = "3";
            
            if (effect === 'fill' || effect === 'fill-max') {
                path.style.stroke = "#D4AF37";
                path.style.filter = "drop-shadow(0 0 8px #D4AF37)";
            } else if (effect === 'hold-full') {
                path.style.stroke = "#FFFFFF";
                path.style.filter = "drop-shadow(0 0 15px #FFFFFF)";
            } else if (effect === 'drain') {
                path.style.stroke = "#555";
            } else if (effect === 'hold-empty') {
                path.style.stroke = "#333";
            } else {
                path.style.stroke = "#222";
            }
        }

        function speak(text) {
            if(!ui.voiceToggle.checked) return;
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 1.3; 
            window.speechSynthesis.speak(u);
        }

        function playSound(effect) {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (effect === 'fill' || effect === 'fill-max') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(220, t);
                osc.frequency.linearRampToValueAtTime(440, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'drain') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, t);
                osc.frequency.linearRampToValueAtTime(220, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'hold-full') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(660, t);
                gain.gain.setValueAtTime(0.03, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.5);
            } else if (effect === 'hold-empty') {
                // ‰ΩéÈ†ªÊñπÊ≥¢ÂòüËÅ≤
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                osc.start(t);
                osc.stop(t + 0.4);
            }
        }

        function playCompleteSound() {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // ÈêòËÅ≤Èü≥Êïà (Sine, Low freq, Long release)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(330, t); // E4
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.0001, t + 3);
            
            osc.start(t);
            osc.stop(t + 3);
            
            // ÂíåËÅ≤
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(493, t); // B4
            gain2.gain.setValueAtTime(0.05, t);
            gain2.gain.exponentialRampToValueAtTime(0.0001, t + 3);
            osc2.start(t);
            osc2.stop(t + 3);
        }
    </script>
</body>
</html>
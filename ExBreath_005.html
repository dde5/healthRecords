<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JJ Breath Ultimate | å°ˆæ¥­å‘¼å¸è¨“ç·´</title>
    <style>
        :root {
            --primary-gold: #D4AF37;
            --bg-color: #000000;
            --panel-bg: #111111;
            --border-color: #333;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           ä½ˆå±€ç³»çµ± (RWD)
           ========================================= */
        
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* è¦–è¦ºå€ (Visual) */
        .visual-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
            overflow: hidden;
        }

        /* æ§åˆ¶å€ (Controls) - ç›´å‘æ™‚åœ¨ä¸‹æ–¹ */
        .control-panel {
            flex-shrink: 0;
            width: 100%;
            height: 45%; /* ç›´å‘æ™‚é«˜åº¦ä½”æ¯” */
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        /* æ©«å‘æ¨¡å¼ (Landscape) */
        @media (orientation: landscape) {
            .app-container {
                flex-direction: row;
            }

            .visual-area {
                flex: 6; /* å·¦å´ä½” 60% */
                height: 100%;
                border-right: 1px solid var(--border-color);
                background: radial-gradient(circle at center, #1a1a1a 0%, #000 80%);
            }

            .control-panel {
                flex: 4; /* å³å´ä½” 40% */
                width: auto;
                height: 100%;
                border-top: none;
                border-left: 1px solid var(--border-color);
            }
        }

        /* =========================================
           å…ƒä»¶æ¨£å¼
           ========================================= */

        h1 {
            color: var(--primary-gold);
            font-weight: 300;
            letter-spacing: 4px;
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            text-align: center;
        }

        select {
            width: 100%;
            padding: 12px;
            background: #222;
            border: 1px solid #444;
            color: var(--primary-gold);
            font-size: 1rem;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 5px;
        }

        /* æ™‚é–“æŒ‰éˆ• */
        .duration-control {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .time-btn {
            flex: 1;
            background: #222;
            border: 1px solid #444;
            color: #888;
            padding: 8px 0;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-btn.active {
            background: var(--primary-gold);
            color: #000;
            border-color: var(--primary-gold);
            font-weight: bold;
        }

        /* æŒ‰éˆ•çµ„ */
        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .btn {
            flex: 1; padding: 15px; border: none; border-radius: 6px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .btn-start { background: linear-gradient(135deg, #D4AF37 0%, #997b28 100%); color: #000; }
        .btn-stop { background: #333; color: #888; border: 1px solid #555; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .options-bar {
            display: flex; justify-content: center; gap: 20px;
            color: #aaa; font-size: 0.9rem; margin-bottom: 5px;
        }
        .toggle-option { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .toggle-option input { accent-color: var(--primary-gold); width: 16px; height: 16px; }

        /* èªªæ˜å¡ç‰‡ (å®Œæ•´å…§å®¹) */
        .info-card {
            background: #151515;
            border-left: 3px solid var(--primary-gold);
            padding: 15px;
            border-radius: 0 6px 6px 0;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #ccc;
            white-space: pre-line; /* ä¿ç•™æ›è¡Œ */
        }
        .info-card h3 { color: var(--primary-gold); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* è‡ªè¨‚è¼¸å…¥ */
        .custom-inputs {
            display: none; grid-template-columns: repeat(4, 1fr); gap: 5px;
            background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .custom-inputs.show { display: grid; }
        .input-group label { font-size: 0.7rem; color: #aaa; display: block; text-align: center; }
        .input-group input { width: 100%; background: #000; border: 1px solid #555; color: var(--primary-gold); text-align: center; padding: 5px; }

        /* =========================================
           MASTER SVG æ¨£å¼
           ========================================= */
        
        .master-svg {
            width: 100%;
            height: 100%;
            max-width: 90vh; /* ç¨å¾®æ”¾å¤§ */
            max-height: 90vh;
        }

        .track-path {
            fill: none;
            stroke: #333;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.3s;
        }

        .dot-circle {
            fill: #fff;
            stroke: var(--primary-gold);
            stroke-width: 2;
            filter: drop-shadow(0 0 5px var(--primary-gold));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lung-group {
            opacity: 0.4;
            transition: opacity 0.5s;
        }
        
        .lung-shape {
            stroke: #444;
            stroke-width: 1.5;
            fill: url(#fluidGradient);
        }
        .lung-outline {
            fill: none;
            stroke: var(--primary-gold);
            stroke-width: 1.5;
        }

        /* SVG æ–‡å­—æ¨£å¼ (è§£æ±ºæ“‹ä½å•é¡Œçš„æ ¸å¿ƒ) */
        .svg-text {
            font-family: "Helvetica Neue", Arial, sans-serif;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: #fff;
            pointer-events: none;
            /* é—œéµï¼šæ–‡å­—æé‚Šï¼Œç¢ºä¿åœ¨é‡‘è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è¦‹ */
            paint-order: stroke;
            stroke: rgba(0,0,0,0.9);
            stroke-width: 4px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .text-timer { 
            font-size: 28px; 
            font-weight: 700; 
        }
        
        .text-action { 
            font-size: 12px; 
            font-weight: 900; 
            letter-spacing: 3px; 
            fill: var(--primary-gold); /* å…§éƒ¨é‡‘è‰² */
            text-transform: uppercase;
        }

        .total-timer {
            position: absolute;
            bottom: 10px;
            font-size: 1rem;
            color: #666;
            font-family: monospace;
        }
        .total-timer span { color: var(--primary-gold); }

        #wakeLockVideo { position: absolute; width: 1px; height: 1px; opacity: 0.001; pointer-events: none; }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- è¦–è¦ºå€ -->
        <div class="visual-area">
            <svg class="master-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <linearGradient id="fluidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop id="stopTop" offset="100%" stop-color="transparent" />
                        <stop id="stopBottom" offset="100%" stop-color="#D4AF37" />
                    </linearGradient>
                </defs>

                <!-- 1. èƒŒæ™¯è»Œè·¡ (æœ€åº•å±¤) -->
                <path id="trackPath" class="track-path" d="" />

                <!-- 2. è‚ºéƒ¨åœ–å½¢ (ä¸­é–“å±¤) - æ”¾å¤§ç‰ˆ -->
                <!-- 
                   åŸæœ¬ 200x200 path. 
                   Scale 0.35 => 70x70 size.
                   Center offset = (100 - 70)/2 = 15.
                -->
                <g class="lung-group" id="lungGroup" transform="translate(15, 15) scale(0.35)">
                     <path id="lungPath" class="lung-shape" d="M 95,40 C 60,40 35,70 35,110 C 35,150 65,170 90,165 C 95,164 95,140 95,140 Z M 105,40 C 140,40 165,70 165,110 C 165,150 135,170 110,165 C 105,164 105,140 105,140 Z" />
                     <path class="lung-outline" d="M 95,40 C 60,40 35,70 35,110 C 35,150 65,170 90,165 C 95,164 95,140 95,140 Z M 105,40 C 140,40 165,70 165,110 C 165,150 135,170 110,165 C 105,164 105,140 105,140 Z" />
                     <path stroke="#D4AF37" stroke-width="2" fill="none" d="M 95,40 L 95,10 L 105,10 L 105,40"/>
                </g>

                <!-- 3. å‘¼å¸å…‰é» -->
                <circle id="dot" class="dot-circle" r="2.5" cx="0" cy="0" />

                <!-- 4. æ–‡å­— (æœ€ä¸Šå±¤) - ç¢ºä¿ DOM é †åºåœ¨æœ€å¾Œ -->
                <text id="timerText" class="svg-text text-timer" x="50" y="52"></text>
                <text id="actionText" class="svg-text text-action" x="50" y="65">READY</text>
            </svg>

            <div class="total-timer" id="totalTimerDisplay">
                å‰©é¤˜æ™‚é–“: <span>5:00</span>
            </div>
        </div>

        <!-- æ§åˆ¶å€ -->
        <div class="control-panel">
            <h1>JJ BREATH</h1>

            <select id="breathSelector">
                <option value="box">æ–¹å¡Šå‘¼å¸æ³• (Box Breathing)</option>
                <option value="custom">âš™ï¸ è‡ªè¨‚æ¨¡å¼ (Custom)</option>
                <option value="478">4-7-8 å‘¼å¸æ³• (å€’ä¸‰è§’)</option>
                <option value="diaphragm">è…¹å¼å‘¼å¸æ³• (æ­£ä¸‰è§’)</option>
                <option value="cyclic">å¾ªç’°æ­æ¯å‘¼å¸ (åœ“å½¢)</option>
                <option value="humming">èœ‚é³´å‘¼å¸æ³• (åœ“å½¢)</option>
            </select>

            <div class="duration-control">
                <button class="time-btn" data-min="1">1åˆ†</button>
                <button class="time-btn" data-min="3">3åˆ†</button>
                <button class="time-btn active" data-min="5">5åˆ†</button>
                <button class="time-btn" data-min="10">10åˆ†</button>
                <button class="time-btn" data-min="0">ç„¡é™</button>
            </div>

            <div class="custom-inputs" id="customPanel">
                <div class="input-group"><label>å¸æ°£</label><input type="number" id="cIn" value="4"></div>
                <div class="input-group"><label>é–‰æ°£</label><input type="number" id="cH1" value="4"></div>
                <div class="input-group"><label>åæ°£</label><input type="number" id="cEx" value="4"></div>
                <div class="input-group"><label>é–‰æ°£</label><input type="number" id="cH2" value="4"></div>
            </div>

            <div class="options-bar">
                <label class="toggle-option"><input type="checkbox" id="voiceToggle" checked> èªéŸ³</label>
                <label class="toggle-option"><input type="checkbox" id="soundToggle" checked> éŸ³æ•ˆ</label>
            </div>

            <div class="btn-group">
                <button id="startBtn" class="btn btn-start">é–‹å§‹ START</button>
                <button id="stopBtn" class="btn btn-stop" disabled>åœæ­¢ STOP</button>
            </div>

            <div class="info-card">
                <h3 id="infoTitle">æ–¹å¡Šå‘¼å¸æ³•</h3>
                <div id="infoContent"></div>
            </div>
        </div>
    </div>

    <video id="wakeLockVideo" playsinline muted loop>
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNNEVAAAAAAAAAAAEAAACgYW1vbQAAAAAAAAAAAAAAAAAAAABtb292AAAAbG12aGQAAAAA6a2gAAAAAAHAAACaAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKgbWRhdAAAAAAAAAAAAAAA" type="video/mp4">
    </video>

    <script>
        const presets = {
            box: {
                title: "æ–¹å¡Šå‘¼å¸æ³• (Box Breathing)",
                shapePath: "M 10,90 L 10,10 L 90,10 L 90,90 L 10,90", 
                cycle: [4, 4, 4, 4],
                actions: ["å¸æ°£", "æ’ä½", "åæ°£", "æ’ä½"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `ğŸ’¡ç·Šå¼µã€ç„¦æ…®ã€å£“åŠ›å¤§æ™‚ï¼Œä½ æ˜¯å¦æ›¾æ„Ÿåˆ°å¿ƒè·³åŠ é€Ÿã€è…¦è¢‹ç©ºç™½ï¼Ÿåœ¨é€™æ¨£çš„æ™‚åˆ»ï¼Œæˆ‘å€‘å…¶å¯¦å¯ä»¥é ã€Œå‘¼å¸ã€ï¼Œé‡å•Ÿå…§åœ¨çš„ç©©å®šåŠ›ã€‚

ğŸ’¡ç¾åœ‹æµ·è»é™¸æˆ°éšŠä¸Šæˆ°å ´å‰ï¼Œéƒ½æœƒé€²è¡Œä¸€é …å‘¼å¸è¨“ç·´â€”ã€Œæ–¹å¡Šå‘¼å¸æ³•ã€ï¼ˆBox Breathingï¼‰ã€‚é€™æ˜¯ä¸€ç¨®çµåˆå¸æ°£ã€é–‰æ°£ã€åæ°£çš„ç°¡å–®ç·´ç¿’ï¼Œæ¯å€‹éšæ®µéƒ½æ˜¯4ç§’ï¼Œåƒä¸€å€‹ç©©å®šçš„æ­£æ–¹å½¢ç¯€å¥ï¼Œå› æ­¤ç¨±ä½œã€Œæ–¹å¡Šå‘¼å¸ã€ã€‚

ç·´ç¿’æ–¹å¼å¦‚ä¸‹ï¼ˆæ­£æ–¹å½¢å¾ªç’°ï¼‰ï¼š
1ï¸âƒ£ å¸æ°£ 4 ç§’ï¼šé»ç”±ä¸‹å¾€ä¸Šï¼Œèƒ½é‡å……æ»¿ã€‚
2ï¸âƒ£ æ’ä½ 4 ç§’ï¼šé»å‘å³æ©«ç§»ï¼Œæ°£æ¯ä¿æŒã€‚
3ï¸âƒ£ åæ°£ 4 ç§’ï¼šé»ç”±ä¸Šå¾€ä¸‹ï¼Œå£“åŠ›é‡‹æ”¾ã€‚
4ï¸âƒ£ æ’ä½ 4 ç§’ï¼šé»å‘å·¦æ©«ç§»ï¼Œæ”¾ç©ºæ­¸é›¶ã€‚

å†å¾ç¬¬1æ­¥é–‹å§‹å¾ªç’°~ é€™æ¨£çš„å‘¼å¸ï¼Œä¸åªæ˜¯æ”¾é¬†ï¼Œæ›´èƒ½æ´»åŒ–å‰¯äº¤æ„Ÿç¥ç¶“ï¼Œå¹«åŠ©ä½ åœ¨ç„¦æ…®ä¸­æ‰¾å›ç©©å®šã€‚`
            },
            custom: {
                title: "è‡ªè¨‚æ¨¡å¼ (Custom Mode)",
                shapePath: "M 10,90 L 10,10 L 90,10 L 90,90 L 10,90",
                cycle: [4, 4, 4, 4],
                actions: ["å¸æ°£", "æ’ä½", "åæ°£", "æ’ä½"],
                effects: ["fill", "hold-full", "drain", "hold-empty"],
                desc: `ğŸ’¡é€²éšä½¿ç”¨è€…çš„è‡ªç”±è¨­å®šæ¨¡å¼ã€‚

æ‚¨å¯ä»¥æ ¹æ“šè‡ªå·±çš„è‚ºæ´»é‡èˆ‡è¨“ç·´éœ€æ±‚ï¼Œåœ¨ä¸Šæ–¹è¼¸å…¥æ¡†èª¿æ•´ï¼š
- å¸æ°£æ™‚é–“
- é–‰æ°£ï¼ˆå……ç›ˆï¼‰æ™‚é–“
- åæ°£æ™‚é–“
- é–‰æ°£ï¼ˆæ’ç©ºï¼‰æ™‚é–“

é»æ“Šã€Œé–‹å§‹ã€å¾Œå°‡ä¾ç…§æ‚¨çš„è¨­å®šé€²è¡Œå¾ªç’°ã€‚`
            },
            "478": {
                title: "4-7-8 å‘¼å¸æ³•",
                shapePath: "M 50,90 L 10,10 L 90,10 L 50,90", 
                cycle: [4, 7, 8],
                actions: ["å¸æ°£", "é–‰æ°£", "åæ°£"],
                effects: ["fill", "hold-full", "drain"],
                desc: `ğŸ’¡ç•¶å£“åŠ›ä¾†è¥²æ™‚ï¼Œä½ æ˜¯å¦æƒ³å¿«é€Ÿå¹³å¾©æƒ…ç·’ï¼Ÿ4-7-8å‘¼å¸æ³•æ˜¯ç”±Andrew Weilåšå£«é–‹ç™¼çš„æŠ€å·§ï¼Œæºè‡ªç‘œä¼½æ™®æ‹‰ç´äºç‘ªï¼ˆpranayamaï¼‰ï¼Œç ”ç©¶é¡¯ç¤ºå®ƒèƒ½æœ‰æ•ˆé™ä½ç„¦æ…®æ°´å¹³ã€æ”¹å–„ç¡çœ ï¼Œä¸¦èª¿ç¯€ç¥ç¶“ç³»çµ±ã€‚

ğŸ’¡è‡¨åºŠç ”ç©¶ç™¼ç¾ï¼Œé€™ç¨®å‘¼å¸æ³•åœ¨æ‰‹è¡“å¾Œæ‚£è€…ä¸­èƒ½é¡¯è‘—æ¸›å°‘ç„¦æ…®ã€‚å¾æ°£è„ˆè§’åº¦ï¼Œå®ƒå¼·èª¿å»¶é•·åæ°£ï¼Œæœ‰åŠ©æ–¼é‡‹æ”¾ç©å£“çš„èƒ½é‡ã€‚

ç·´ç¿’æ–¹å¼å¦‚ä¸‹ï¼ˆå€’ä¸‰è§’å½¢ï¼‰ï¼š
1ï¸âƒ£ å¸æ°£ 4 ç§’ï¼šé»å¾åº•éƒ¨å¾€ä¸Šï¼Œå¸å…¥èƒ½é‡ã€‚
2ï¸âƒ£ é–‰æ°£ 7 ç§’ï¼šé»æ©«å‘ç§»å‹•ï¼Œå……åˆ†äº¤æ›æ°£é«”ã€‚
3ï¸âƒ£ åæ°£ 8 ç§’ï¼šé»å‘ä¸‹åŒ¯èšï¼Œå¾¹åº•æ”¾é¬†ï¼ˆç™¼å‡ºå˜¶è²ï¼‰ã€‚
å»ºè­°é©åˆè€ƒè©¦å‰æˆ–ç¡å‰ä½¿ç”¨ã€‚`
            },
            diaphragm: {
                title: "è…¹å¼å‘¼å¸æ³• (Diaphragmatic)",
                shapePath: "M 10,90 L 50,10 L 90,90 L 10,90",
                cycle: [5, 5, 2],
                actions: ["å¸æ°£", "åæ°£", "æ”¾é¬†"],
                effects: ["fill", "drain", "hold-empty"],
                desc: `ğŸ’¡æ„Ÿè¦ºå‘¼å¸æ·ºçŸ­ã€èƒ¸æ‚¶æ™‚ï¼Œè©¦è©¦è…¹å¼å‘¼å¸å§ï¼é€™æ˜¯åŸºç¤çš„æ·±å‘¼å¸æŠ€å·§ï¼Œå°ˆæ³¨æ–¼ä½¿ç”¨æ©«è†ˆè†œï¼Œè®“å‘¼å¸æ›´æ·±å±¤ï¼Œç ”ç©¶è­‰å¯¦å®ƒèƒ½é™ä½ç”Ÿç†å£“åŠ›æŒ‡æ¨™ï¼Œå¦‚çš®è³ªé†‡æ°´å¹³ã€‚

ğŸ’¡å¤šé …ç ”ç©¶é¡¯ç¤ºï¼Œè…¹å¼å‘¼å¸èƒ½æœ‰æ•ˆæ¸›è¼•ç„¦æ…®å’Œè² é¢æƒ…ç·’ã€‚å®ƒæ¿€æ´»å‰¯äº¤æ„Ÿç¥ç¶“ï¼Œå¹«åŠ©ç–é€šèƒ¸è…¹èƒ½é‡ï¼Œä¿ƒé€²å…§åœ¨ç©©å®šã€‚

ç·´ç¿’æ–¹å¼å¦‚ä¸‹ï¼ˆæ­£ä¸‰è§’å½¢ï¼‰ï¼š
1ï¸âƒ£ å¸æ°£ 5 ç§’ï¼šè…¹éƒ¨é¼“èµ·ï¼Œé»å¾€ä¸Šèµ°ã€‚
2ï¸âƒ£ åæ°£ 5 ç§’ï¼šè…¹éƒ¨æ”¶ç¸®ï¼Œé»å¾€ä¸‹èµ°ã€‚
3ï¸âƒ£ æ”¾é¬† 2 ç§’ï¼šé»æ©«å‘å›æ­¸ï¼Œæº–å‚™ä¸‹ä¸€æ¬¡å¾ªç’°ã€‚
é©åˆåˆå­¸è€…æˆ–æ—¥å¸¸æ¸›å£“ã€‚`
            },
            cyclic: {
                title: "å¾ªç’°æ­æ¯å‘¼å¸ (Cyclic Sighing)",
                shapePath: "M 50,90 A 40,40 0 0 1 50,10 A 40,40 0 0 1 50,90", 
                cycle: [3, 1, 6],
                actions: ["å¸æ°£", "å†å¸", "æ­æ°£"],
                effects: ["fill", "fill-max", "drain"],
                desc: `ğŸ’¡æƒ³åœ¨çŸ­æ™‚é–“å…§æ”¹å–„å¿ƒæƒ…ï¼Ÿå¾ªç’°æ­æ¯å‘¼å¸æ˜¯ç”±æ–¯å¦ç¦å¤§å­¸ç ”ç©¶é–‹ç™¼çš„æŠ€å·§ï¼Œå¼·èª¿å»¶é•·åæ°£ï¼Œç ”ç©¶é¡¯ç¤ºå®ƒæ¯”å…¶ä»–å‘¼å¸æ³•æ›´æœ‰æ•ˆæå‡å¿ƒæƒ…ä¸¦é™ä½ç”Ÿç†å–šé†’ã€‚

ğŸ’¡ä¸€é …æ§åˆ¶è©¦é©—ç™¼ç¾ï¼Œæ¯å¤©5åˆ†é˜ç·´ç¿’èƒ½é¡¯è‘—æ¸›è¼•ç„¦æ…®ä¸¦æ”¹å–„æƒ…ç·’ï¼Œç”šè‡³å„ªæ–¼æ­£å¿µå†¥æƒ³ã€‚å®ƒæ¨¡æ“¬è‡ªç„¶æ­æ¯ï¼Œå¹«åŠ©é‡‹æ”¾å£“åŠ›èƒ½é‡ã€‚

ç·´ç¿’æ–¹å¼å¦‚ä¸‹ï¼š
1ï¸âƒ£ å¸æ°£ 3 ç§’ï¼šé¼»å­æ·±å¸æ°£ï¼Œæ“´å¼µè‚ºéƒ¨ã€‚
2ï¸âƒ£ å†å¸ 1 ç§’ï¼šçŸ­å¸ä¸€å£ï¼Œè£œæ»¿è‚ºæ´»é‡ã€‚
3ï¸âƒ£ æ­æ°£ 6 ç§’ï¼šå˜´å·´é•·é•·åæ°£ï¼Œé‡‹æ”¾æ‰€æœ‰å£“åŠ›ã€‚`
            },
            humming: {
                title: "èœ‚é³´å‘¼å¸æ³• (Bhramari)",
                shapePath: "M 50,90 A 40,40 0 0 1 50,10 A 40,40 0 0 1 50,90",
                cycle: [4, 8],
                actions: ["å¸æ°£", "èœ‚é³´"],
                effects: ["fill", "drain"],
                desc: `ğŸ’¡è…¦ä¸­å—¡å—¡äº‚æƒ³æ™‚ï¼Œä¾†é»æŒ¯å‹•ç™‚æ³•ï¼èœ‚é³´å‘¼å¸æ³•æºè‡ªç‘œä¼½ï¼Œé€éå“¼é³´è²ç”¢ç”ŸæŒ¯å‹•ï¼Œç ”ç©¶é¡¯ç¤ºå®ƒèƒ½é™ä½å¿ƒç‡ã€æ¸›è¼•æŒ«æŠ˜æ„Ÿå’Œç„¦æ…®ã€‚

ğŸ’¡ç³»çµ±å›é¡§ç™¼ç¾ï¼Œé€™ç¨®ç·´ç¿’èƒ½æ”¹å–„é«˜è¡€å£“ã€ç„¦æ…®å’Œå£“åŠ›ç›¸é—œç—‡ç‹€ã€‚æŒ¯å‹•æœ‰åŠ©æ–¼åˆºæ¿€è…¦éƒ¨ï¼Œç–é€šèƒ½é‡å µå¡ï¼Œå¸¶ä¾†å¯§éœã€‚

ç·´ç¿’æ–¹å¼å¦‚ä¸‹ï¼š
1ï¸âƒ£ å¸æ°£ 4 ç§’ï¼šé»å¾€ä¸Šèµ°ã€‚
2ï¸âƒ£ èœ‚é³´ 8 ç§’ï¼šé–‰å˜´ç™¼å‡ºã€Œå—¯â€”ã€è²åæ°£ï¼Œé»å¾€ä¸‹èµ°ã€‚
æ¯å¤©æ—©æ™šç·´ç¿’ï¼Œæ•ˆæœæ›´ä½³ã€‚`
            }
        };

        const ui = {
            select: document.getElementById('breathSelector'),
            customPanel: document.getElementById('customPanel'),
            cInputs: [document.getElementById('cIn'), document.getElementById('cH1'), document.getElementById('cEx'), document.getElementById('cH2')],
            title: document.getElementById('infoTitle'),
            content: document.getElementById('infoContent'),
            track: document.getElementById('trackPath'),
            dot: document.getElementById('dot'),
            timer: document.getElementById('timerText'),
            action: document.getElementById('actionText'),
            start: document.getElementById('startBtn'),
            stop: document.getElementById('stopBtn'),
            lungGroup: document.getElementById('lungGroup'),
            stopTop: document.getElementById('stopTop'),
            stopBottom: document.getElementById('stopBottom'),
            video: document.getElementById('wakeLockVideo'),
            voiceToggle: document.getElementById('voiceToggle'),
            soundToggle: document.getElementById('soundToggle'),
            totalTimer: document.getElementById('totalTimerDisplay'),
            timeBtns: document.querySelectorAll('.time-btn')
        };

        let isRunning = false;
        let animationFrame = null;
        let audioCtx = null;
        let currentKey = 'box';
        let wakeLock = null;
        let totalDurationMinutes = 5; 
        let sessionStartTime = 0;

        // åˆå§‹åŒ–
        loadPreset('box');
        updateTotalTimerDisplay(totalDurationMinutes * 60);

        ui.timeBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(isRunning) return;
                ui.timeBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                totalDurationMinutes = parseInt(e.target.dataset.min);
                updateTotalTimerDisplay(totalDurationMinutes * 60);
            });
        });

        ui.select.addEventListener('change', (e) => {
            if(isRunning) stop();
            loadPreset(e.target.value);
        });

        ui.start.addEventListener('click', () => {
            ui.video.play().catch(()=>{});
            requestWakeLock();
            start();
        });

        ui.stop.addEventListener('click', () => stop(false));

        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible" && isRunning) {
                requestWakeLock();
                ui.video.play().catch(()=>{});
            }
        });

        function loadPreset(key) {
            currentKey = key;
            const data = presets[key];

            ui.customPanel.classList.toggle('show', key === 'custom');
            ui.title.innerText = data.title;
            ui.content.innerText = data.desc;
            
            ui.track.setAttribute('d', data.shapePath);
            const pt = ui.track.getPointAtLength(0);
            updateDot(pt);
            resetState();
        }

        function getCycle() {
            let data = JSON.parse(JSON.stringify(presets[currentKey]));
            if (currentKey === 'custom') {
                data.cycle = ui.cInputs.map(i => parseFloat(i.value) || 4);
            }
            return data;
        }

        async function start() {
            if(isRunning) return;
            isRunning = true;
            sessionStartTime = performance.now();

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();

            ui.start.disabled = true;
            ui.stop.disabled = false;
            ui.select.disabled = true;
            ui.customPanel.style.pointerEvents = 'none';
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'none');
            
            ui.dot.style.opacity = 1;
            ui.lungGroup.style.opacity = 1;

            runLoop();
        }

        function stop(finished = false) {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            window.speechSynthesis.cancel();
            
            ui.video.pause();
            if(wakeLock) wakeLock.release().then(()=> wakeLock=null);

            ui.start.disabled = false;
            ui.stop.disabled = true;
            ui.select.disabled = false;
            ui.customPanel.style.pointerEvents = 'auto';
            ui.timeBtns.forEach(b => b.style.pointerEvents = 'auto');

            resetState();

            if (finished) {
                ui.action.textContent = "COMPLETE";
                ui.timer.textContent = "";
                playCompleteSound();
            }
        }

        function resetState() {
            ui.dot.style.opacity = 0;
            ui.lungGroup.style.opacity = 0.3;
            ui.timer.textContent = "";
            ui.action.textContent = "READY";
            setFluidLevel(100); 
            updateShapeColor('default');
            
            const pt = ui.track.getPointAtLength(0);
            updateDot(pt);
            
            if(totalDurationMinutes === 0) {
                 updateTotalTimerDisplay(0, true);
            } else {
                 updateTotalTimerDisplay(totalDurationMinutes * 60);
            }
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        async function runLoop() {
            const data = getCycle();
            let phaseIdx = 0;

            while(isRunning) {
                const duration = data.cycle[phaseIdx];
                const action = data.actions[phaseIdx];
                const effect = data.effects[phaseIdx];

                await runPhase(duration, action, effect, phaseIdx, data);
                
                if (checkTotalTimeUp()) {
                    stop(true);
                    break;
                }
                phaseIdx = (phaseIdx + 1) % data.cycle.length;
            }
        }

        function checkTotalTimeUp() {
            if (totalDurationMinutes === 0) return false;
            const elapsed = (performance.now() - sessionStartTime) / 1000;
            return elapsed >= (totalDurationMinutes * 60);
        }

        function runPhase(duration, action, effect, idx, data) {
            return new Promise(resolve => {
                const startTime = performance.now();
                const totalLen = ui.track.getTotalLength();
                const numSegments = data.cycle.length;
                let startRatio = idx / numSegments;
                let endRatio = (idx + 1) / numSegments;
                const segmentLen = (endRatio - startRatio) * totalLen;
                const baseDist = startRatio * totalLen;

                ui.action.textContent = action; 
                updateShapeColor(effect);

                let hasSpokenStart = false;
                let spokenCount = new Set();

                function frame(now) {
                    if(!isRunning) { resolve(); return; }

                    const sessionElapsed = (now - sessionStartTime) / 1000;
                    if (totalDurationMinutes > 0) {
                        const totalRemaining = (totalDurationMinutes * 60) - sessionElapsed;
                        updateTotalTimerDisplay(totalRemaining);
                        if (totalRemaining <= 0) { resolve(); return; }
                    } else {
                        updateTotalTimerDisplay(sessionElapsed, true);
                    }

                    const elapsed = (now - startTime) / 1000;
                    const progress = Math.min(elapsed / duration, 1);
                    const remaining = Math.ceil(duration - elapsed);

                    if(remaining >= 0) ui.timer.textContent = remaining;

                    if (!hasSpokenStart) {
                        hasSpokenStart = true;
                        speak(action);
                        playSound(effect);
                    }

                    if (remaining <= 3 && remaining >= 1 && !spokenCount.has(remaining)) {
                        spokenCount.add(remaining);
                        speak(remaining.toString());
                    }

                    const currentDist = baseDist + (segmentLen * progress);
                    const pt = ui.track.getPointAtLength(currentDist % totalLen);
                    updateDot(pt);
                    updateLung(effect, progress);

                    if(progress < 1) {
                        animationFrame = requestAnimationFrame(frame);
                    } else {
                        resolve();
                    }
                }
                animationFrame = requestAnimationFrame(frame);
            });
        }

        function updateTotalTimerDisplay(seconds, isElapsed = false) {
            if (seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            const timeStr = `${m}:${s.toString().padStart(2, '0')}`;
            const label = isElapsed ? "å·²ç·´ç¿’: " : "å‰©é¤˜æ™‚é–“: ";
            ui.totalTimer.innerHTML = (totalDurationMinutes === 0 && !isElapsed) 
                ? "æ¨¡å¼: <span>ç„¡é™</span>" 
                : `${label}<span>${timeStr}</span>`;
        }

        function updateDot(pt) {
            ui.dot.setAttribute('cx', pt.x);
            ui.dot.setAttribute('cy', pt.y);
        }

        function updateLung(effect, progress) {
            let level = 100;
            if(effect === 'fill') level = 100 - (progress * 100);
            else if(effect === 'drain') level = progress * 100;
            else if(effect === 'hold-full' || effect === 'fill-max') level = 0;
            else if(effect === 'hold-empty') level = 100;
            setFluidLevel(level);
        }

        function setFluidLevel(pct) {
            ui.stopTop.setAttribute('offset', pct + '%');
            ui.stopBottom.setAttribute('offset', pct + '%');
        }

        function updateShapeColor(effect) {
            const path = ui.track;
            path.style.filter = "none";
            
            if (effect === 'fill' || effect === 'fill-max') {
                path.style.stroke = "#D4AF37";
                path.style.filter = "drop-shadow(0 0 5px #D4AF37)";
            } else if (effect === 'hold-full') {
                path.style.stroke = "#FFFFFF";
                path.style.filter = "drop-shadow(0 0 10px #FFFFFF)";
            } else if (effect === 'drain') {
                path.style.stroke = "#666";
            } else if (effect === 'hold-empty') {
                path.style.stroke = "#333";
            } else {
                path.style.stroke = "#333";
            }
        }

        function speak(text) {
            if(!ui.voiceToggle.checked) return;
            window.speechSynthesis.cancel(); 
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.rate = 1.3; 
            window.speechSynthesis.speak(u);
        }

        function playSound(effect) {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (effect === 'fill' || effect === 'fill-max') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(220, t);
                osc.frequency.linearRampToValueAtTime(440, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'drain') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, t);
                osc.frequency.linearRampToValueAtTime(220, t + 2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 2);
                osc.start(t);
                osc.stop(t + 2);
            } else if (effect === 'hold-full') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(660, t);
                gain.gain.setValueAtTime(0.03, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                osc.start(t);
                osc.stop(t + 0.5);
            } else if (effect === 'hold-empty') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                osc.start(t);
                osc.stop(t + 0.4);
            }
        }

        function playCompleteSound() {
            if(!ui.soundToggle.checked || !audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(330, t);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.0001, t + 3);
            osc.start(t);
            osc.stop(t + 3);
        }
    </script>
</body>
</html>